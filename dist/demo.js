var demo=function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";s.r(e);class i{constructor(t={}){if(t[0])return this[0]=t[0],this[1]=t[1]||[-1,-1,-1,-1,-1,-1],void(this[2]=t[2]||null);this[0]=t.noteValue||4,this[1]=t.stringContent||[-1,-1,-1,-1,-1,-1],this[2]=t.userData||null}get noteValue(){return this[0]}set noteValue(t){this[0]=t}get stringContent(){return this[1]}set stringContent(t){this[1]=t}get userData(){return this[2]}set userData(t){this[2]=t}}var n;!function(t){t.setAttributes=function(t,e){for(let s in e)t.setAttribute(s,e[s])},t.setStyle=function(t,e){for(let s in e)t.style.setProperty(s,e[s])};const e={C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11},s=/^([CDEFGAB]#?)([0-9])$/;t.noteToDecimal=function(t){let i=s.exec(t);return 3!=i.length?-1:e[i[1]]+12*(Number(i[2])+1)}}(n||(n={}));class o{constructor(){this.funcs=[]}callAll(...t){this.funcs.forEach(e=>{e(...t)})}push(t){this.funcs.push(t)}}class r{constructor(t){t.forEach(t=>{this[t]=new o})}}class l{constructor(t,e,s,i){this.domElement=t,this.word=e,this.wordBack=s,this.extendRect=i}set x(t){this._x!==t&&(this._x=t,this.word.x=t,this.wordBack.x=t,this.extendRect.x=t)}get x(){return this._x}set y(t){this._y!==t&&(this._y=t,this.word.y=t+4,this.wordBack.y=t+4)}get y(){return this._y}set section(t){this._section=t}get section(){return this._section}set note(t){this._note=t}get note(){return this._note}set string(t){this._string=t}get string(){return this._string}set line(t){this._line=t}get line(){return this._line}on(t,e){this.domElement.addEventListener(t,e)}}class a{constructor(t,e,s){this.blockGroup=[],this.lineGroup=[],this.domElement=t,this.blockGroup=e,this.lineGroup=s,this.tail8=new c,this.tail16=new d,this.tail32=new u,this.domElement.append(this.tail32.domElement,this.tail16.domElement,this.tail8.domElement)}set section(t){this._section=t}get section(){return this._section}set note(t){this._note=t}get note(){return this._note}set line(t){this._line=t}get line(){return this._line}on(t,e){this.domElement.addEventListener(t,e)}}class h{constructor(){this._isShow=!0,this.domElement=document.createElementNS("http://www.w3.org/2000/svg","g"),n.setAttributes(this.domElement,{style:"fill: white;"})}setPosition(t,e){this._x===t&&this._y===e||(n.setStyle(this.domElement,{transform:`scale(0.08) translate(${t/.08}px,${e/.08}px)`}),this._x=t,this._y=e)}show(){this._isShow||(this._isShow=!0,n.setStyle(this.domElement,{display:"unset"}))}hide(){this._isShow&&(this._isShow=!1,n.setStyle(this.domElement,{display:"none"}))}}class c extends h{constructor(){super(),this.domElement.innerHTML='<use xlink:href="#stail8"></use>'}}class d extends h{constructor(){super(),this.domElement.innerHTML='<use xlink:href="#stail16"></use>'}}class u extends h{constructor(){super(),this.domElement.innerHTML='<use xlink:href="#stail32"></use>'}}class m{constructor(){this.linker=[],this.domElement=document.createElementNS("http://www.w3.org/2000/svg","g")}clear(){this.domElement.innerHTML=""}createRect(t,e,s,i,o,r,l){const a=document.createElementNS("http://www.w3.org/2000/svg","rect");return n.setAttributes(a,{x:`${t}`,y:`${e}`,width:`${s}`,height:`${i}`,"stroke-width":`${o}`,fill:r}),l?l.appendChild(a):this.domElement.appendChild(a),new b(a)}createEllipse(t,e,s,i,o){const r=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return n.setAttributes(r,{cx:`${t}`,cy:`${e}`,rx:`${s}`,ry:`${i}`}),o?o.appendChild(r):this.domElement.appendChild(r),new p(r)}createText(t,e,s,i,o){const r=document.createElementNS("http://www.w3.org/2000/svg","text");return n.setAttributes(r,{x:`${t}`,y:`${e}`,"text-anchor":`${i}`}),r.innerHTML=`${s}`,o?o.appendChild(r):this.domElement.appendChild(r),new f(r)}createLine(t,e,s,i,o,r,l){const a=document.createElementNS("http://www.w3.org/2000/svg","line");return n.setAttributes(a,{x1:`${t}`,y1:`${e}`,x2:`${s}`,y2:`${i}`,stroke:`${r}`,"stroke-width":`${o}`}),l?l.appendChild(a):this.domElement.appendChild(a),new y(a)}createLinker(t){let e=document.createElementNS("http://www.w3.org/2000/svg","path");return t?t.appendChild(e):this.domElement.appendChild(e),n.setAttributes(e,{fill:"white"}),this.linker.push(e),e}}class g{constructor(t){this._domElement=t}remove(){this._domElement.remove()}get domElement(){return this._domElement}set style(t){n.setStyle(this.domElement,t)}on(t,e){this._domElement.addEventListener(t,e)}}class b extends g{constructor(t){super(t)}setPos(t,e){n.setAttributes(this.domElement,{x:`${t}`,y:`${e}`})}setShape(t,e){n.setAttributes(this.domElement,{width:`${t}`,height:`${e}`})}set x(t){this._x!==t&&(this._x=t,n.setAttributes(this.domElement,{x:`${t}`}))}get x(){return this._x}set y(t){this._y!==t&&(this._y=t,n.setAttributes(this.domElement,{y:`${t}`}))}get y(){return this._y}set width(t){this._width!==t&&(this._width=t,n.setAttributes(this.domElement,{width:`${t}`}))}get width(){return this._width}set height(t){this._height!==t&&(this._height=t,n.setAttributes(this.domElement,{height:`${t}`}))}get height(){return this._height}set strokeWidth(t){n.setAttributes(this.domElement,{"stroke-width":`${t}`})}get strokeWidth(){return Number(this.domElement.getAttribute("stroke-width"))}set fill(t){n.setAttributes(this.domElement,{fill:`${t}`})}get fill(){return this.domElement.getAttribute("fill")}}class p extends g{constructor(t){super(t)}setPos(t,e){n.setAttributes(this.domElement,{cx:`${t}`,cy:`${e}`})}setShape(t,e,s,i){n.setAttributes(this.domElement,{rx:`${s}`,ry:`${i}`})}set cx(t){this._cx!=t&&(this._cx=t,n.setAttributes(this.domElement,{cx:`${t}`}))}get cx(){return this._cx}set cy(t){this._cy!=t&&(this._cy=t,n.setAttributes(this.domElement,{cy:`${t}`}))}get cy(){return this._cy}set rx(t){this._rx!=t&&(this._rx=t,n.setAttributes(this.domElement,{rx:`${t}`}))}get rx(){return this._rx}set ry(t){this._ry!=t&&(this._ry=t,n.setAttributes(this.domElement,{ry:`${t}`}))}get ry(){return this._ry}set fill(t){n.setAttributes(this.domElement,{fill:`${t}`})}get fill(){return this.domElement.getAttribute("fill")}}class y extends g{constructor(t){super(t)}setEndPoints(t,e,s,i){n.setAttributes(this.domElement,{x1:`${t}`,y1:`${e}`,x2:`${s}`,y2:`${i}`})}set x1(t){this._x1!=t&&(this._x1=t,n.setAttributes(this.domElement,{x1:`${t}`}))}get x1(){return Number(this.domElement.getAttribute("x1"))}set y1(t){this._y1!=t&&(this._y1=t,n.setAttributes(this.domElement,{y1:`${t}`}))}get y1(){return Number(this.domElement.getAttribute("y1"))}set x2(t){this._x2!=t&&(this._x2=t,n.setAttributes(this.domElement,{x2:`${t}`}))}get x2(){return Number(this.domElement.getAttribute("x2"))}set y2(t){this._y2!=t&&(this._y2=t,n.setAttributes(this.domElement,{y2:`${t}`}))}get y2(){return Number(this.domElement.getAttribute("y2"))}set stroke(t){n.setAttributes(this.domElement,{stroke:`${t}`})}get stroke(){return this.domElement.getAttribute("stroke")}set strokeWidth(t){n.setAttributes(this.domElement,{"stroke-width":`${t}`})}get strokeWidth(){return Number(this.domElement.getAttribute("stroke-width"))}}class f extends g{constructor(t){super(t)}setPos(t,e){n.setAttributes(this.domElement,{x:`${t}`,y:`${e}`})}set x(t){this._x!=t&&(this._x=t,n.setAttributes(this.domElement,{x:`${t}`}))}get x(){return Number(this.domElement.getAttribute("x"))}set y(t){this._y!=t&&(this._y=t,n.setAttributes(this.domElement,{y:`${t}`}))}get y(){return Number(this.domElement.getAttribute("y"))}set anchor(t){n.setAttributes(this.domElement,{"text-anchor":`${t}`})}get anchor(){return this.domElement.getAttribute("text-anchor")}set text(t){this.domElement.innerHTML!==t&&(this.domElement.innerHTML=`${t}`)}get text(){return this.domElement.innerHTML}set strokeWidth(t){n.setAttributes(this.domElement,{"stroke-width":`${t}`})}get strokeWidth(){return Number(this.domElement.getAttribute("stroke-width"))}set fill(t){n.setAttributes(this.domElement,{fill:`${t}`})}}class w extends m{constructor(){super(),this.noteElements=[],this.dot=[],this.domElement.innerHTML='\n        <defs>\n            <path id="SVGTAIL8_1" d="M-4.728,151.313l10.303,2.061l39.153-33.854c0,0,20.543-24.318,23.338-67.708L70.34,0H43.846L22.061,78.012\n                l-33.854,20.901L-4.728,151.313z"/>\n        \t<clipPath id="SVGTAIL8_2">\n                <use xlink:href="#SVGTAIL8_1"  style="overflow:visible;"/>\n            </clipPath>\n\n            <path id="stail16"d="M67.37,59.776c2.698-19.84-2.806-39.01-7.124-58.173C60.138,1.127,59.523,0.765,58.825,0c0,3.411-0.317,6.266,0.054,9.029\n            c1.69,12.576,0.707,25.062-2.478,37.175c-5.494,20.897-15.163,39.32-35.394,49.69c-6.397,3.279-13.599,4.99-20.612,7.443\n            l-0.168,42.842c0.429-1.459,1.031-2.899,1.881-4.318c5.712-9.535,13.379-17.275,23.422-21.731\n            c11.728-5.203,21.372-12.634,29.432-22.407c0.486-0.59,1.154-1.029,2.017-1.782c-6.693,34.412-26.894,55.961-56.794,60.555\n            L0,203.874c1.634-4.092,2.518-8.621,4.922-12.148c5.906-8.664,14.092-14.797,23.71-19.308c16.597-7.786,30.016-19.532,35.085-37.498\n            c3.198-11.333,4.22-23.682,3.872-35.506C67.2,86.185,65.551,73.148,67.37,59.776z"/>\n        \n            <path id="stail8" style="clip-path:url(#SVGTAIL8_2);" d="M67.352,64.184c2.698-19.84-2.806-39.01-7.124-58.173\n            c-0.107-0.476-0.722-0.837-1.42-1.603c0,3.411-0.317,6.266,0.054,9.029c1.69,12.576,0.707,25.062-2.478,37.175\n            c-5.494,20.897-15.163,39.32-35.394,49.69c-6.397,3.279-13.599,4.99-20.612,7.443l-0.168,42.842\n            c0.429-1.459,1.031-2.899,1.881-4.318c5.712-9.535,13.379-17.275,23.422-21.731c11.728-5.203,21.372-12.634,29.432-22.407\n            c0.486-0.59,1.154-1.029,2.017-1.782c-6.693,34.412-26.894,55.961-56.794,60.555l-0.186,47.379\n            c1.634-4.092,2.518-8.621,4.922-12.148c5.906-8.664,14.092-14.797,23.71-19.308c16.597-7.786,30.016-19.532,35.085-37.498\n            c3.198-11.333,4.22-23.682,3.872-35.506C67.182,90.594,65.534,77.557,67.352,64.184z"/>\n\n            <path id="SVGID_1_" d="M-4.17,255.543l10.303,2.061l39.153-33.854c0,0,20.543-24.318,23.338-67.708l2.274-51.812H44.404\n                l-21.784,78.012l-33.854,20.901L-4.17,255.543z"/>\n            <clipPath id="SVGID_2_">\n                <use xlink:href="#SVGID_1_"  style="overflow:visible;"/>\n            </clipPath>\n            <g id="stail32">\n            <path d="M67.183,59.776c2.698-19.84-2.806-39.01-7.124-58.173C59.952,1.127,59.337,0.765,58.639,0c0,3.411-0.317,6.266,0.054,9.029\n\t\tc1.69,12.576,0.707,25.062-2.478,37.175c-5.494,20.897-15.163,39.32-35.394,49.69c-6.397,3.279-13.599,4.99-20.612,7.443\n\t\tl-0.168,42.842c0.429-1.459,1.031-2.899,1.881-4.318c5.712-9.535,13.379-17.275,23.422-21.731\n\t\tc11.728-5.203,21.372-12.634,29.432-22.407c0.486-0.59,1.154-1.029,2.017-1.782C50.101,130.352,29.9,151.901,0,156.495\n\t\tl-0.186,47.379c1.634-4.092,2.518-8.621,4.922-12.148c5.906-8.664,14.092-14.797,23.71-19.308\n\t\tc16.597-7.786,30.016-19.532,35.085-37.498c3.198-11.333,4.22-23.682,3.872-35.506C67.013,86.185,65.365,73.148,67.183,59.776z"/>\n            <path style="clip-path:url(#SVGID_2_);" d="M67.91,168.414c2.698-19.84-2.806-39.01-7.124-58.173\n\t\t\tc-0.107-0.476-0.722-0.837-1.42-1.603c0,3.411-0.317,6.266,0.054,9.029c1.69,12.576,0.707,25.062-2.478,37.175\n\t\t\tc-5.494,20.897-15.163,39.32-35.394,49.69c-6.397,3.279-13.599,4.99-20.612,7.443l-0.168,42.842\n\t\t\tc0.429-1.459,1.031-2.899,1.881-4.318c5.712-9.535,13.379-17.275,23.422-21.731c11.728-5.203,21.372-12.634,29.432-22.407\n\t\t\tc0.486-0.59,1.154-1.029,2.017-1.782c-6.693,34.412-26.894,55.96-56.794,60.555L0.54,312.512\n\t\t\tc1.634-4.092,2.518-8.621,4.922-12.148c5.906-8.664,14.092-14.797,23.71-19.308c16.597-7.786,30.016-19.532,35.085-37.498\n            c3.198-11.333,4.22-23.682,3.872-35.506C67.74,194.823,66.092,181.786,67.91,168.414z"/>\n            </g>\n        </defs>\n        ',n.setAttributes(this.domElement,{"data-layer":"NoteLayer"})}createNote(t=-1){const e=document.createElementNS("http://www.w3.org/2000/svg","g"),s=document.createElementNS("http://www.w3.org/2000/svg","g"),i=[],o=document.createElementNS("http://www.w3.org/2000/svg","g"),r=[];r.push(this.createLine(0,0,0,0,1,"white",o));for(let t=0;t<3;t++)r.push(this.createLine(0,0,0,0,2,"white",o));e.append(o);for(let t=0;t<6;t++){const t=document.createElementNS("http://www.w3.org/2000/svg","g"),e=this.createRect(0,0,0,0,0,"rgba(0, 0, 0, 0)",t),o=this.createText(0,0,"","middle",t),r=this.createText(0,0,"","middle",t);n.setAttributes(t,{"stroke-width":"0",stroke:"black",style:"cursor:pointer;"}),o.strokeWidth=3,o.style={font:"12px Sans-serf"},r.style={font:"12px Sans-serif",fill:"#fff"},s.append(t),i.push(new l(t,r,o,e))}e.append(s),-1===t&&(t=this.noteElements.length);let h=new a(e,i,r);return this.noteElements.splice(t,0,h),this.domElement.append(e),h}removeNote(t,e=1){for(let s=0;s<e;s++)this.noteElements[t+s]&&this.domElement.removeChild(this.noteElements[t+s].domElement);this.noteElements.splice(t,e)}}class A extends m{constructor(){super(),this.row=[],this.bar=[],n.setAttributes(this.domElement,{"data-layer":"SheetLayer"})}createRow(t,e,s,i,o,r){let l=document.createElementNS("http://www.w3.org/2000/svg","g"),a=document.createElementNS("http://www.w3.org/2000/svg","rect");n.setAttributes(a,{x:`${t}`,y:`${e}`,style:"fill: rgba(255, 255, 255, 0.09)",width:`${2*i[0]+s}`,height:`${2*i[1]+5*o}`}),l.appendChild(a),t+=i[0],e+=i[1];for(let i=0;i<6;i++){let n=s;this.createLine(t,e+i*o,t+n,e+i*o,2,"rgba(255, 255, 255, 0.24)",l)}this.drawRowTitle(t-30,e,l),this.createLine(t,e,t,e+5*o,2,"rgba(255, 255, 255, 0.24)",l);for(let t=0;t<r;t++){let t=this.createLine(0,e,0,e+5*o,2,"rgba(255, 255, 255, 0.24)",this.domElement);this.bar.push(t)}return this.domElement.append(l),this.row.push(l),l}drawRowTitle(t,e,s){let i=document.createElementNS("http://www.w3.org/2000/svg","g");return i.innerHTML=`\n        <text style="fill:#959595;font:17px arial;">\n            <tspan x='${t+10}' y='${e+26}'>T</tspan>\n            <tspan x='${t+10}' y='${e+22+26}'>A</tspan>\n            <tspan x='${t+10}' y='${e+44+26}'>B</tspan>\n        </text>\n        `,s&&s.append(i),i}}class k extends m{constructor(){super(),this.sectionIndicator=[],n.setAttributes(this.domElement,{"data-layer":"UILayer"})}createSectionIndicator(){let t=this.createRect(0,0,0,0,0,"rgba(0, 255, 255, 0)");return this.sectionIndicator.push(t),t}hightLightSection(t){n.setAttributes(this.sectionIndicator[t].domElement,{fill:"rgba(0, 255, 255, 0.13)"})}hideSectionIndicator(t){n.setAttributes(this.sectionIndicator[t].domElement,{fill:"rgba(0, 255, 255, 0)"})}}class S{constructor(){this.background=new m,this.sheet=new A,this.notes=new w,this.foreground=new m}get flattened(){return[this.background,this.sheet,this.notes,this.foreground]}}class T extends S{constructor(){super(),this.ui=new k}get flattened(){return[this.background,this.sheet,this.ui,this.notes,this.foreground]}}class N{constructor(t){this.layerType=t,this.layers=new t,this.domElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),n.setStyle(this.domElement,{"user-select":"none",outline:"none"}),this.layers.flattened.forEach(t=>this.domElement.appendChild(t.domElement))}}class v{setData(t){this.clearData();let e=[];for(let s=0;s<t.length;s++){let n=[];for(let e=0;e<t[s].length;e++){let o=new i({noteValue:t[s][e][0],stringContent:t[s][e][1],userData:t[s][e][2]});n.push(o)}e.push(n)}this.notes=e}getNoteData(t,e){return this.notes[t][e]}setNoteData(t,e,s){this.notes[t][e]=s}setStringDataOfNote(t,e,s,i){s>=0&&s<=5&&(this.notes[t][e][1][s]=i)}getSectionData(t){return this.notes[t]}deleteNote(t,e,s=1){return this.notes[t].splice(e,s)}addNote(t,e,s){return(-1===t||t>=this.notes.length)&&(t=this.notes.length,this.notes.push([])),(-1===e||e>this.notes[t].length)&&(e=this.notes[t].length),this.notes[t].splice(e,0,s),[t,e]}isBlankNote(t,e){for(let s=0;s<6;s++)if(-1!=this.notes[t][e][1][s])return!1;return!0}getNoteNumberOfSection(t){return this.notes[t]?this.notes[t].length:-1}getSectionNumber(){return this.notes.length}insertSection(t,e=[]){return!(t<0||t>this.notes.length)&&(this.notes.splice(t,0,e),!0)}deleteSections(t,e=1){return t<-1||t>=this.notes.length?[]:this.notes.splice(t,e)}getNoteFlattenNumber(t,e){if(!this.notes[t])return-1;if(this.notes[t][e]){let s=0;for(let e=0;e<t;e++)s+=this.notes[e].length;return s+=e}return-1}clearData(){this.notes=[[]]}}class E extends v{constructor(){super(...arguments),this.containerHeight=700,this.lineWidth=1200,this.sectionPerLine=4,this.stringPadding=16,this.linePerPage=20,this.lineMargin=42,this.linePadding=[32,14],this.lineDistance=90,this.startPosition=[this.lineMargin+this.linePadding[0]+20,120+this.linePadding[1]],this.lineStartPosition=[this.lineMargin,120]}getSectionLeftTopPos(t){return t<this.notes.length?[this.tabCanvas.layers.ui.sectionIndicator[t].x,this.tabCanvas.layers.ui.sectionIndicator[t].y]:[-1,-1]}getSectionWidth(t){return t<this.notes.length&&this.tabCanvas.layers.ui.sectionIndicator[t].width,0}getSectionHeight(t){return t<this.notes.length&&this.tabCanvas.layers.ui.sectionIndicator[t].height,0}attach(t){t.append(this.domElement),n.setStyle(t,{width:`${this.width+20}px`})}noteIndex(t){return this.tabCanvas.layers.notes.noteElements.indexOf(t)}getSVGNote(t,e){return this.tabCanvas.layers.notes.noteElements.find(s=>s.section==t&&s.note==e)}getNotePosition(t,e,s=0){let i=0;if(t>=this.notes.length||t<0||e>=this.notes[t].length||e<0||s>5||s<0)return[-1,-1];if(0===this.notes[t].length)return[-1,-1];for(let e=0;e<t;e++)i+=this.notes[e].length;if(i+=e,!this.tabCanvas.layers.notes.noteElements[i])return[-1,-1];let n=this.tabCanvas.layers.notes.noteElements[i].blockGroup[s];return[n.x,n.y]}clearData(){super.clearData(),this.tabCanvas.layers.notes.removeNote(0,this.tabCanvas.layers.notes.noteElements.length)}}class x extends E{constructor(){super(...arguments),this.inEdit=!0}scrollTo(t){this.domElement.scrollTop=t}adjustPostion(t){t+220>this.domElement.scrollTop+this.containerHeight&&this.scrollTo(t-this.containerHeight+220),t-80<this.domElement.scrollTop&&this.scrollTo(t-80)}areaSelect(t,e,s,i){let n=this.tabCanvas.layers.notes.noteElements;var o=[];let r,l;for(let r=0;r<n.length;r++)for(let l=0;l<6;l++)n[r].blockGroup[l].x>=t&&n[r].blockGroup[l].x<=s&&n[r].blockGroup[l].y>=e&&n[r].blockGroup[l].y<=i&&"none"!=n[r].domElement.style.display&&o.push(r);return r=Math.min(...o),l=Math.max(...o),n.slice(r,l+1)}endsSelect(t,e){if(t>e){let s=e;e=t,t=s}return this.tabCanvas.layers.notes.noteElements.slice(t,e+1)}headToEndSelect(t){return this.tabCanvas.layers.notes.noteElements.slice(t,this.tabCanvas.layers.notes.noteElements.length)}addNote(t,e,s){return this.inEdit?super.addNote(t,e,s):[-1,-1]}}class C{constructor(t){this.device=t,this.callbacks=new r(["pick","message"]),this.startTime=performance.now(),this.device.onmidimessage=this.onMessage.bind(this)}on(t,e){t in this.callbacks&&this.callbacks[t].push(e)}resetTimer(){this.startTime=performance.now()}static isSupported(){return navigator.requestMIDIAccess}static async enumerate(){let t=[];if(C.isSupported()){let e=await navigator.requestMIDIAccess();for(let s of e.inputs.values())if(s.name.match(/LiCAP MIDI Device/)){t.push(new C(s)),console.log(`use ${s.name}`);break}}return t}onMessage(t){let e=15&t.data[0],s=[40,45,50,55,59,64].reverse();switch(t.data[0]>>4&15){case 8:break;case 9:this.device.name!==C.LiCAPName?this.callbacks.message.callAll(t):this.callbacks.pick.callAll(e,t.data[1]-s[e],t.data[2]/255,t.timeStamp)}}}C.LiCAPName="LiCAP MIDI Device";let P="data:audio/wav;base64,UklGRhAHAABXQVZFZm10IBAAAAABAAIARKwAABCxAgAEABAAZGF0YegGAAD6/wQA+v8AADoA6v8k/1YAMgB+/koD6gAuAJQEFPu0/Yr+0vkYAVb/VgB4AQYClgFuBfIERATsBvj9GAPQ+fT6oPoo9xL94Pd+/h77mv/s/5QBVgPWA84DJAUcBOAFngZoBkwILgOYBtT+jgB6/Fb6evhm+wrzBv7Y8yz40vxm8z4D8vKIA071lgT0/IgHeAl0CfIUsgpQHMYK+h+KCwIZTAkqCIQBJvd+9qjpVOoI38TfkNqa2sTdtt0k4troGuCg96TgWAdG7XIUfgL0GtwZJiFcLsIsKjx4MyY/tC/sQaIkzkK0EmQ1YP4WH8zyvgUy8S7oWO2E1XrkHNXq35TWDOFI1DrgatV64IjUtuc60QjqKNhQ6VrlmvFK7Sr8uPLE+mb7Du+CAATlIPtO5J7vIOpc31T2uNOKBHrcAguW9fIKdhBUEsgsrimyR8hEGlSYVNBWxlVkWg9LXVz/OUBXGitpSBgjRS/ZHcoSAhIy/ZL/zvNi7gXy4+HQ7oXZYejt1eLinNWH3IDTbdDm0UHFxdVTxUXXS8wAzlrQL8LOzgW+zMHlwFSoCcW+mFTKiKFn0jK7ttui2sjm8/bN93IM8gN1Bz0KHgs1DtsNjg85EKYQaRKMEvETuxPnE80S1xFYEOoOzQ1KDT4MVQ1iDKQNzg3cDX8Otw7sDE0PjglDDVIFZwi2AbkCYv+u/vH8dfxw+b/5SPVt9UDw1O/R6n7q3+at58rleud85ovokOc56mXpAOwJ7HjtAe9E7hLyY++J9T/y1flP9rz+z/koA3D8RAZY/0wIywLCCSgGUAsQCkQO5w6dEkcTKBaiFngXBxpGF9wcsRbSHLwVrxlFFL8VsRKSEvwQsg9+DnQMqAoYCbMF9QXZAAYDifwPAGL4zfyy9HX5oPFb9nXuWfM36yHwhui27Bjndekw55bmBOiX5OLoUORK6rDlbOyy57vuyOkW8p3sOvfC8Bn9SvZJAi79LgYpBBoJQwmgC6cM7g0SD+EP8g9HEdIPXBJsEFsT0RGwExMTRRMjFPASLhUcE9QVORP6FYISkxV6EBkU1QyMEQMIRw4nA90JpP4eBEb6xv079tj3fPIB88jui+/a61TtZOpi6wfqC+l66lHn2euE57LtXulT79Xrz/Ci7rTyhvEo9Zzzjvdz9K359/Qr/Jj2NP+q+VUCef2hBbEBHAlWBkYM/ArMDgYP/hBUEigTIBXeFFoXbRWdGJ8UqBjHEm0XKhDlFCoNbBFOCswNtQejCiMFDQidArsFOAA2A9T9OwBx++L8Dvmd+Y/27fY/9Nf0hPLe8iPx3fCx7+HuTe7S7HDt8ep17fPpk+5l6rDwROxp8/buV/br8UP5FfVH/Mj4Vv/z/DgC9wAbBWgE+wcjB14KHwnVC6kKhAw3DO8M3A1jDU4P0w1VEAsO4RDmDf8QgQ3TENUMbxC3C7EPTwplDr4IZwzIBrAJQASCBkABFgMe/of/H/sY/Gf4/fgp9kD2iPT68zjzH/IP8rTwefHE753xVu8j8nbv7vIY8AP0DvFS9VDy5fbH87b4ZvWq+kP3s/xy+d7+DfwwAQn/egMDAoYFugRHBz4HxAiCCQAKVQsQC7MMAwy4DbUMeg7LDOcONgzlDjwLcg4TCo0N0AgvDH0HbQr2BX8IDQR+BtkBXQSq/wsCrf2E/9T79fwa+on6l/hM+Er3X/Y59vf0ifUS9D/1evNN9TDzt/VF82v2nvNK9070WviA9a35H/ck++z4r/yf+lT+IPz4/6r9hwF5//UCYgE1BEIDTAUWBUgGvgYhBwcIvgfvCBYIlgknCPwJ6wcACnUHqwnNBiYJ+AVwCAEFcAfsAyIGuAKpBHkBJANLALcBPP9uAEz+L/91/eX9o/yl/Nb7k/sn+8z6p/pD+mP63vlf+o/5ifpW+cz6TPko+4n5ofsG+jr8sPr//H775/1i/NX+VP2y/1j+dQBr/x0BfgC1AXcBQAJDArwC1gIcAzsDTwOEA1YDuwNEA+UDKwP5AwwD6gPbArcDlQJjAz4C+wLZAY0CbAEhAv8AtAGSAEABHgC6AKf/JwA2/5T/1f4N/4f+of5N/lL+K/4a/hv+9/0b/uP9Kv7f/Un+7v10/hL+pv5E/t3+ev4W/7b+U//4/pD/PP/H/3v/+f+1/ycA6/9RACAAdABRAI8AewCiAJoArgCvALQAvQC0AMUAsADGAKgAwQCYALUAhACjAG0AjABVAHQAPgBaACkAQAAWACkABQAVAPf/BADs//j/5P/u/9//5//d/+L/3f/f/97/3//h/+D/5f/j/+n/5//u/+v/8v/v//b/9P/5//f//P/6//7//f////7/AAD//wAAAAAAAAAA",D="data:audio/wav;base64,UklGRuYDAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0Yb4DAADw/wAAGAAgAOD+AP0I/Bj7OPr4+Uj5gPhw+BD4gPeQ96j5qPyo/vj9GPwo++j8wP9oAbAC6AOIBBADgADI/kj96PtI+9AB0AtgEYAZyCK4JlAimBkgBmjwAOUI3gDZKNco3LjlEO2o/CAQqBr4FqAM2ASw+njvCOpA+JAPOBzYDejzUOYw8PACmA1IEGAQkA8IC2AE8P44+rj2iPnQ7iDaQNOQ3QjscO6g57DjCOlA8qDzQPHY8QjzGPswBoANSBfAIGgooD52V+Ze1lDAOmgoFyAnHqYgpSCVG7YQ3wJp+br5vfEb4kHZ7tNr0JfP6sQWtxizELpLwR/KP9Wy4ZfwtfwLA+IPax58I1QaagxnA/AIoRXaFngM4wPRAc4EbwYrBQv4COl447jfxN604WfpJfRs+zD85Pzn/tcG/hXtILYm2S6MM8s0QStrH58fDiZgKXkm+R1yFEAPigbL/2H9Afvz9+D0mei/3XHX29cS3pfhzuYu7FbqU+i06cXshfNp+w8AcAl6E4oXdRIsDqEN7A09Do4OhAnmDh0ZnxqUFMgMWgNH8QjjNuBi5LbrH/G98bbxvfJ99pL+PgUqAtr5LPRF+0AJsxKtGnAd8hqTEtQKoAeXEoUcDh0TGsQTJg5OB+gBtADY/zEBQQPIAon88fU48rzsF+mJ6VbtH/Iy9fT5u/74AHcILBHCFJATnQ8IDKYVwiLxJ7keYBCoB/kCCQIqAzkD2ADm/Sr5CvUu9CjuuOeo4mLhsuQB7p/3T/x7/Qb+nP7wAysK2gxzDEgNLA4KEN4QQw9pCjECzvve+nz9zgCM/2n70/hn/SEFxAo3Cz8GyP/q/VUCeghMDbwPTw4wCjgF9gJNAwkH1wt4DWULBwhQBdkC5/3o+Rj5j/q//G/+H/kG8qPvHfKi9ur6LP45/37+6PnG9Zr1aPkF/rEABACJ/cT7QwDzBgQKyghbBfwATv7Q+277Mf2F//QAawEFA4YFugaiBaADmgKoAEP/Vf9B/j78xPrU+0/+UQBxAdsASP+j/g8ABQJhA10D8gHh//z+3P8OAd8BQAJjA0YEEgRDAzwBK/8n/S/8qvzI/eH+iv+D/3T+h/1P/g8ASQF0AJ/+a/0g/osApgJ3A/QCsgGRAC4A+f9UAN8AFwHNAGcAcwAjAKb/av/W/mL+SP57/g//tv/t/1j/of5q/k3+Tv6f/rb+mv6U/uf+ZP/I/xkASQBCAEgAYwB2AHgAZwBJADwAOwAzAAYA0v/B/83/3//w/wIADgAOAAcA";const B=function(t,e,s,n,o=""){t.deleteNote(s,n,t.getNoteNumberOfSection(s));let r=0;for(let e=0;e<n;e++)r+=t.lengthPerBeat/t.notes[s][e][0];if(e.userData+=` ${o}`,r>=t.beatPerSection)t.insertSection(t.getSectionNumber(),[]),t.addNote(s+1,-1,e);else{if(r+t.lengthPerBeat/e[0]>t.beatPerSection){let n=t.beatPerSection-r,l=t.lengthPerBeat/(t.lengthPerBeat/e[0]-n);return n=t.lengthPerBeat/n,t.addNote(s,-1,new i({noteValue:n,stringContent:e[1],userData:"linkStart "+o})),t.insertSection(t.getSectionNumber(),[]),void B(t,new i({noteValue:l,stringContent:e[1],userData:""}),s+1,0,"linkEnd")}{let n=1-r%1;if(n>=t.lengthPerBeat/e[0])t.addNote(s,-1,e);else{let r=t.lengthPerBeat/e[0]-n;t.addNote(s,-1,new i({noteValue:t.lengthPerBeat/n,stringContent:e[1],userData:"linkStart "+o})),t.addNote(s,-1,new i({noteValue:t.lengthPerBeat/r,stringContent:e[1],userData:"linkEnd"}))}}}};class I{constructor(){this._running=!1,this._systemTime=0,this.lastTime=0,this.delay=33,this.funcs=[],this.timerId=null,this.executeFuncs=[]}searchIndex(t){let e=this.executeFuncs,s=0,i=e.length,n=0;for(;s<i;)t>=e[n=Math.floor(s+(i-s)/2)].time?s=n+1:i=n-1;return s}register(t){this.funcs.indexOf(t)||this.funcs.push(t)}registerDelay(t,e,s=1){let i=this._systemTime+e;this.registerDelayP(t,e,i,s)}unregister(t){this.funcs.map((e,s)=>{t===e&&this.funcs.splice(s,1)})}start(t=0){this._running||(this._running=!0,this._systemTime=t,this.lastTime=(new Date).getTime(),this.update())}stop(){this.timerId&&(clearTimeout(this.timerId),this.timerId=null),this._running=!1,this._systemTime=0,this.lastTime=0,this.clearFuncs(),this.clearDelayFuncs()}update(){let t=(new Date).getTime(),e=t-this.lastTime;this._systemTime+=e,this.funcs.forEach(t=>{t(e)}),this.executeFunc(),this.lastTime=t,this._running&&(this.timerId=setTimeout(this.update.bind(this),this.delay))}executeFunc(){if(this.executeFuncs[0]&&this.executeFuncs[0].time<this._systemTime){let t=this.executeFuncs.shift();if(t.func(),this.executeFunc(),t.loop>0&&0==--t.loop)return;let e=t.time+t.delay;this.registerDelayP(t.func,t.delay,e,t.loop)}}clearFuncs(){this.funcs=[]}clearDelayFuncs(){this.executeFuncs=[]}registerDelayP(t,e,s,i){let n=this.searchIndex(s),o={func:t,delay:e,time:s,loop:i};this.executeFuncs.splice(n,0,o)}}let L=[329.63,246.94,196,146.83,110,82.41],M=69,G=440,$=12;let V=new class{constructor(){this.unit=Math.pow(Math.E,Math.log(2)/$)}noteKeyToFrequency(t){let e=t-M;return Math.pow(this.unit,e)*G}frequencyToStringData(t){let e=L.length-1;for(let s=0;s<L.length;s++)if(t>=L[s]){e=s;break}return[e,Math.floor(Math.log(t/L[e])/Math.log(this.unit))]}},O=new class extends x{constructor(t){super(),this.lengthPerBeat=4,this.beatPerSection=4,this.calData=[],this.sectionAddNoteNumber=8,Object.assign(this,t),this.tabCanvas=new N(T),this.width=this.lineWidth+2*this.linePadding[0]+84,n.setAttributes(this.tabCanvas.domElement,{width:`${this.width}`}),this.domElement=document.createElement("div"),this.domElement.append(this.tabCanvas.domElement),this.domElement.addEventListener("keydown",t=>{[32,37,38,39,40].includes(t.keyCode)&&(t.preventDefault(),t.returnValue=!1)}),n.setStyle(this.domElement,{width:`${this.width+20}px`,height:`${this.containerHeight}px`,"overflow-y":"auto","overflow-x":"hidden"}),this.callbacks=new r(["noteclick","noteshiftclick","notealtclick","notectrlclick","keydown","mouseovernote","mouseoutnote","mousedown","mousemove","mouseup","rightclick","sectionhover","sectionhout","sectionclick"]),n.setAttributes(this.domElement,{tabindex:"-1"}),this.domElement.addEventListener("keydown",this.onKeydown.bind(this)),this.domElement.addEventListener("mousedown",this.onMouseDown.bind(this)),this.domElement.addEventListener("mousemove",this.onMouseMove.bind(this)),this.domElement.addEventListener("mouseup",this.onMouseUp.bind(this)),this.domElement.addEventListener("contextmenu",this.onMouseRightClick.bind(this))}instrumentNoteInput(t,e,s=-1,i=-1){-1==s&&(s=this.notes.length-1),-1==i&&(i=this.notes[s].length),t(this,e,s,i),this.render()}render(){this.setAllLine();let[t,e,s,i,o]=this.calNoteData();this.setSectionIndicator(i),this.setAllNoteElementData(t,e),this.setLinker(s),this.setDot(o);let r=Math.ceil(this.notes.length/this.sectionPerLine);this.height!=this.lineStartPosition[1]+(5*this.stringPadding+this.lineDistance)*r+70&&(this.height=this.lineStartPosition[1]+(5*this.stringPadding+this.lineDistance)*r+70,n.setAttributes(this.tabCanvas.domElement,{height:`${this.height}`}))}on(t,e){t in this.callbacks&&this.callbacks[t].push(e)}isSectionFull(t){let e=0;for(let s=0;s<this.notes[t].length;s++)e+=this.lengthPerBeat/this.notes[t][s][0];return e>=this.beatPerSection}deleteNote(t,e,s=1){let i=this.getNoteFlattenNumber(t,e),n=this.notes[t].splice(e,s);return this.removeCalData(i,n.length),n}deleteSections(t,e=1){if(t<0||t>=this.notes.length)return[];let s=0,i=this.getNoteFlattenNumber(t,0);for(let i=t;i<t+e&&i<this.notes.length;i++)s+=this.notes[i].length;return this.removeCalData(i,s),this.notes.splice(t,e)}insertSection(t,e=[]){if(t<0||t>this.notes.length)return!1;let s=this.getNoteFlattenNumber(t,this.getNoteNumberOfSection(t)-1),i=[];for(let t=0;t<e.length;t++)i.push({x:-1,y:-1,length:-1,blocks:[],tail:[],section:-1,note:-1,hasSvg:!1});return this.notes.splice(t,0,e),this.calData.splice(s+1,0,...i),!0}clearData(){super.clearData(),this.calData=[]}addNote(t,e,s){if([t,e]=super.addNote(t,e,s),-1!=t){let s=this.getNoteFlattenNumber(t,e);this.calData.splice(s,0,{x:-1,y:-1,length:-1,blocks:[],tail:[],section:-1,note:-1,hasSvg:!1})}return[t,e]}removeCalData(t,e){this.calData.splice(t,e),this.tabCanvas.layers.notes.removeNote(t,e)}setAllLine(){let t=Math.ceil(this.notes.length/this.sectionPerLine),e=this.tabCanvas.layers.sheet.row.length;for(let s=e;s<t;s++){let t=this.lineStartPosition[0],e=this.lineStartPosition[1]+(5*this.stringPadding+this.lineDistance)*s;this.tabCanvas.layers.sheet.createRow(t,e,this.lineWidth,this.linePadding,this.stringPadding,this.sectionPerLine)}for(let s=t;s<e;s++)n.setStyle(this.tabCanvas.layers.sheet.row[s],{display:"none"});for(let e=0;e<t;e++)n.setStyle(this.tabCanvas.layers.sheet.row[e],{display:"unset"})}setSectionIndicator(t){if(t.length>this.tabCanvas.layers.ui.sectionIndicator.length){let e=t.length-this.tabCanvas.layers.ui.sectionIndicator.length;for(let t=0;t<e;t++){let t=this.tabCanvas.layers.ui.createSectionIndicator();t.on("mousemove",this.onSectionHover.bind(this)),t.on("mouseout",this.onSectionHout.bind(this)),t.on("click",this.onSectionClick.bind(this))}}for(let e=0;e<t.length;e++){let s=t[e][1][0]-t[e][0][0],i=5*this.stringPadding;this.tabCanvas.layers.ui.sectionIndicator[e].x=t[e][0][0],this.tabCanvas.layers.ui.sectionIndicator[e].y=t[e][0][1],this.tabCanvas.layers.ui.sectionIndicator[e].width=s,this.tabCanvas.layers.ui.sectionIndicator[e].height=i,this.tabCanvas.layers.sheet.bar[e].x1=t[e][0][0]+s,this.tabCanvas.layers.sheet.bar[e].x2=t[e][0][0]+s,n.setAttributes(this.tabCanvas.layers.ui.sectionIndicator[e].domElement,{"data-section":`${e}`}),n.setStyle(this.tabCanvas.layers.ui.sectionIndicator[e].domElement,{display:"unset"}),n.setStyle(this.tabCanvas.layers.sheet.bar[e].domElement,{display:"unset"})}for(let e=t.length;e<this.tabCanvas.layers.ui.sectionIndicator.length;e++)n.setStyle(this.tabCanvas.layers.ui.sectionIndicator[e].domElement,{display:"none"}),n.setStyle(this.tabCanvas.layers.sheet.bar[e].domElement,{display:"none"})}calNoteData(){let[t,e]=this.startPosition,s=(this.beatPerSection,this.lengthPerBeat,[]),i=[],n=[],o=0,r=0,l=new Set;for(let a=0;a<this.notes.length;a++){let h=Math.floor(a/this.sectionPerLine),c=0;o=0;for(let t=0;t<this.sectionPerLine;t++)this.notes[h*this.sectionPerLine+t]?c+=Math.max(this.notes[h*this.sectionPerLine+t].length,this.sectionAddNoteNumber):c+=this.sectionAddNoteNumber;let d=this.lineWidth*Math.max(this.notes[a].length,this.sectionAddNoteNumber)/c,u=0;for(let t=0;t<this.notes[a].length;t++)u+=this.lengthPerBeat/this.notes[a][t][0];let m=(d-20)/u;a%this.sectionPerLine==0&&(t=this.startPosition[0],0!=a&&(e+=5*this.stringPadding+this.lineDistance));let g=[[t-20,e],[0,e]],b=t+d;g[1][0]=b-20,n.push(g);for(let n=0;n<this.notes[a].length;n++){let h,c=this.notes[a][n],d=this.lengthPerBeat/c[0];if(o+d/this.lengthPerBeat>=.25){let t=0;r>0&&(t=this.calData[r-1].length),h=this.calculateTail(t,c[0],-1,m),o=0}else{let t=0;r>0&&(t=this.calData[r-1].length),h=this.calculateTail(t,c[0],o,m),o+=d/this.lengthPerBeat}let u=m*this.lengthPerBeat/c[0],g=this.updatecalData(r,t,e,c[0],c[1],h,a,n);g>=0&&l.add(g).add(g-1),r++;let b=[];c[2]&&(b=c[2].split(" ")),b.includes("linkEnd")&&s.push([t,e]),b.includes("linkStart")&&s.push([t,e]),c[0]!==Math.floor(c[0])&&i.push([t,e]),t+=u}t=b}return l.delete(-1),[r,l,s,n,i]}updatecalData(t,e,s,i,n,o,r,l){if(t>this.calData.length)return console.error("array index erro, should not be greater than calData.length"),-1;if(t===this.calData.length)return this.calData.push({x:e,y:s,length:i,blocks:n.slice(0,6),tail:o.slice(0,o.length),section:r,note:l,hasSvg:!1}),t;let a=this.calData[t];return a.x==e&&a.y==s&&a.length==i&&a.section==r&&a.note==l&&this.compareArray(a.blocks,n)&&this.compareArray(a.tail,o)?-1:(this.calData[t].x=e,this.calData[t].y=s,this.calData[t].length=i,this.calData[t].blocks=n.slice(0,6),this.calData[t].tail=o.slice(0,o.length),this.calData[t].section=r,this.calData[t].note=l,t)}compareArray(t,e){if(t.length!=e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!=e[s])return!1;return!0}calculateTail(t,e,s,i){let n=i*this.lengthPerBeat/t*-1,o=8;if(-1==s&&(o=-8),0==s)if(e<=4);else{if(e<=8)return[o,0,0];if(e<=16)return[o,o,0];if(e<=32)return[o,o,o]}else if(e<=4);else if(e<=8){if(t>=8)return[n,0,0]}else if(e<=16)if(t<=4);else{if(t<=8)return[n,o,0];if(t<=32)return[n,n,0]}else if(e<=32)if(t<=4);else{if(t<=8)return[n,o,o];if(t<=16)return[n,n,o];if(t<=32)return[n,n,n]}return[0,0,0]}setAllNoteElementData(t,e){let s=this.calData,i=this.tabCanvas.layers.notes.noteElements,o=(i.length,{x:0,y:0,length:0,blocks:[-1,-1,-1,-1,-1,-1],tail:[0,0,0],section:0,note:0,hasSvg:null});for(let t=0;t<this.calData.length;t++)this.calData[t].hasSvg||(this.tabCanvas.layers.notes.createNote(t),this.calData[t].hasSvg=!0,i[t].blockGroup.forEach((t,e)=>{t.on("click",this.onNoteClicked.bind(this)),t.on("mouseover",this.onMouseOverNote.bind(this)),t.on("mouseout",this.onMouseOutNote.bind(this)),t.string=e,n.setAttributes(t.domElement,{"data-string":`${e}`})}));e.forEach((t,e)=>{e!=s.length-1?s[e+1].x>s[e].x?this.setNoteElementData(i[e],s[e],s[e+1],.7*(s[e+1].x-s[e].x)):this.setNoteElementData(i[e],s[e],s[e+1],30):this.setNoteElementData(i[e],s[e],o,30)})}setNoteElementData(t,e,s,i){this.setElementPosition(t,e.x,e.y,e.tail,e.section,e.note,i),this.setChordVisiable(t,e.x,e.y,e.length,e.blocks,e.tail,s.tail)}setElementPosition(t,e,s,i,o,r,l){let a=Math.floor(o/this.sectionPerLine);t.lineGroup[0].x1=e,t.lineGroup[0].y1=26+s+5*this.stringPadding,t.lineGroup[0].x2=e,t.lineGroup[0].y2=s,t.lineGroup[1].x1=e,t.lineGroup[1].y1=25+s+5*this.stringPadding,t.lineGroup[1].x2=e+i[0],t.lineGroup[1].y2=25+s+5*this.stringPadding,t.lineGroup[2].x1=e,t.lineGroup[2].y1=21+s+5*this.stringPadding,t.lineGroup[2].x2=e+i[1],t.lineGroup[2].y2=21+s+5*this.stringPadding,t.lineGroup[3].x1=e,t.lineGroup[3].y1=17+s+5*this.stringPadding,t.lineGroup[3].x2=e+i[2],t.lineGroup[3].y2=17+s+5*this.stringPadding;for(let i=0;i<6;i++)t.blockGroup[i].x=e,t.blockGroup[i].y=s+this.stringPadding*i,t.blockGroup[i].extendRect.y=s+this.stringPadding*(i-.5),t.blockGroup[i].extendRect.height=this.stringPadding,t.blockGroup[i].extendRect.width=l,n.setAttributes(t.blockGroup[i].domElement,{"data-x":`${e}`,"data-y":`${s+this.stringPadding*i}`,"data-line":`${a}`});t.tail8.setPosition(e+.4,s+5*this.stringPadding+14),t.tail16.setPosition(e+.4,s+5*this.stringPadding+10),t.tail32.setPosition(e+.4,s+5*this.stringPadding+6),t.section=o,t.note=r,t.line=a,n.setAttributes(t.domElement,{"data-section":`${o}`,"data-note":`${r}`}),t.blockGroup.forEach((t,e)=>{t.section=o,t.note=r,t.line=a,n.setAttributes(t.domElement,{"data-section":`${o}`,"data-note":`${r}`,"data-line":`${a}`})})}setChordVisiable(t,e,s,i,n,o,r){let l=!0,a=-1;for(let t=0;t<6;t++)if(-1!=n[t]){a=t;break}t.tail8.hide(),t.tail16.hide(),t.tail32.hide();for(let t=0;t<3;t++)if(o[t]<0||r[t]<0){l=!1;break}l&&(-1!=a&&(i<=4||(i<=8?t.tail8.show():i<=16?t.tail16.show():i<=32&&t.tail32.show())),t.lineGroup[1].x2=e,t.lineGroup[2].x2=e,t.lineGroup[3].x2=e);for(let e=0;e<6;e++)-1==n[e]?(t.blockGroup[e].word.text="",t.blockGroup[e].wordBack.text=""):(t.blockGroup[e].word.text=`${n[e]}`,t.blockGroup[e].wordBack.text=`${n[e]}`);t.lineGroup[0].y2=2!=i?1!=i?-1===a?s+5*this.stringPadding+26:s+this.stringPadding*a:26+s+5*this.stringPadding:10+s+5*this.stringPadding}setLinker(t){let e=Math.floor(t.length/2),s=this.tabCanvas.layers.background.linker.length;for(let t=0;t<e-s;t++)this.tabCanvas.layers.background.createLinker();for(let s=0;s<e;s++)n.setStyle(this.tabCanvas.layers.background.linker[s],{display:"unset"}),this.setLinkerData(this.tabCanvas.layers.background.linker[s],t[2*s],t[2*s+1]);for(let t=e;t<this.tabCanvas.layers.background.linker.length;t++)n.setStyle(this.tabCanvas.layers.background.linker[t],{display:"none"})}setLinkerData(t,e,s){let i=e[1]+31+5*this.stringPadding;if(e[1]!==s[1]){let o=e[0]+30,r=e[0],l=`M ${r} ${i} C ${r+4} ${i+15}, ${o-4} ${i+15}, ${o} ${i} C ${o-4} ${i+12}, ${r+4} ${i+12}, ${r} ${i} `;i=s[1]+31+5*this.stringPadding,l+=`M ${r=s[0]-30} ${i} C ${r+4} ${i+15}, ${(o=s[0])-4} ${i+15}, ${o} ${i} C ${o-4} ${i+12}, ${r+4} ${i+12}, ${r} ${i}`,n.setAttributes(t,{d:l})}else n.setAttributes(t,{d:`M ${e[0]} ${i} C ${e[0]+4} ${i+15}, ${s[0]-4} ${i+15}, ${s[0]} ${i} C ${s[0]-4} ${i+12}, ${e[0]+4} ${i+12}, ${e[0]} ${i}`})}setDot(t){let e=t.length,s=this.tabCanvas.layers.notes.dot.length;for(let t=0;t<e-s;t++){let t=this.tabCanvas.layers.notes.createEllipse(0,0,2.5,2.5);t.fill="white",this.tabCanvas.layers.notes.dot.push(t)}for(let s=0;s<e;s++)n.setStyle(this.tabCanvas.layers.notes.dot[s].domElement,{display:"unset"}),this.tabCanvas.layers.notes.dot[s].cx=t[s][0]+12,this.tabCanvas.layers.notes.dot[s].cy=t[s][1]+12+5*this.stringPadding;for(let t=e;t<this.tabCanvas.layers.notes.dot.length;t++)n.setStyle(this.tabCanvas.layers.notes.dot[t].domElement,{display:"none"})}onNoteClicked(t){let e=Number(t.currentTarget.dataset.section),s=Number(t.currentTarget.dataset.note),i=Number(t.currentTarget.dataset.string),n=[Number(t.currentTarget.dataset.x),Number(t.currentTarget.dataset.y)];t.shiftKey?this.callbacks.noteshiftclick.callAll(e,s,i,n,t.currentTarget):t.altKey?this.callbacks.notealtclick.callAll(e,s,i,n,t.currentTarget):t.ctrlKey?this.callbacks.notectrlclick.callAll(e,s,i,n,t.currentTarget):this.callbacks.noteclick.callAll(e,s,i,n,t.currentTarget)}onKeydown(t){this.callbacks.keydown.callAll(t.key,t.keyCode)}onMouseOverNote(t){let e=Number(t.currentTarget.dataset.section),s=Number(t.currentTarget.dataset.note),i=Number(t.currentTarget.dataset.string),n=[Number(t.currentTarget.dataset.x),Number(t.currentTarget.dataset.y)];this.callbacks.mouseovernote.callAll(e,s,i,n,t.currentTarget)}onMouseOutNote(t){let e=Number(t.currentTarget.dataset.section),s=Number(t.currentTarget.dataset.note),i=Number(t.currentTarget.dataset.string),n=[Number(t.currentTarget.dataset.x),Number(t.currentTarget.dataset.y)];this.callbacks.mouseoutnote.callAll(e,s,i,n,t.currentTarget)}onMouseDown(t){this.callbacks.mousedown.callAll(Number(t.x),Number(t.y))}onMouseMove(t){this.callbacks.mousemove.callAll(Number(t.x),Number(t.y))}onMouseUp(t){this.callbacks.mouseup.callAll(Number(t.x),Number(t.y))}onMouseRightClick(t){this.callbacks.rightclick.callAll(Number(t.x),Number(t.y))}onSectionHover(t){this.callbacks.sectionhover.callAll(Number(t.currentTarget.dataset.section))}onSectionHout(t){this.callbacks.sectionhout.callAll(Number(t.currentTarget.dataset.section))}onSectionClick(t){let e=t.clientY-this.domElement.getBoundingClientRect().top+this.domElement.scrollTop,s=Number(t.currentTarget.getAttribute("y")),i=Math.floor((e-s)/this.stringPadding);this.callbacks.sectionclick.callAll(Number(t.currentTarget.dataset.section),i)}};O.setData([[]]);let _=new class{constructor(t){this.inputBlock=0,this.mouseDown=!1,this.mouseMove=!1,this.selectNotesIndicator=[],this.selectNotesIndicatorPadding=8,this.controlTab=t,this.indicator=this.controlTab.tabCanvas.layers.ui.createEllipse(0,0,8,8),this.shadowIndicator=this.controlTab.tabCanvas.layers.ui.createEllipse(0,0,8,8),this.indicator.cx=-20,this.indicator.cy=-20,this.indicator.fill="rgb(255, 50, 0)",this.shadowIndicator.cx=-20,this.shadowIndicator.cy=-20,this.shadowIndicator.fill="rgba(255, 50, 0, 0.6)",this.dragNDropSection=this.controlTab.tabCanvas.layers.ui.createRect(0,0,0,0,0,"rgba(255, 50, 0, 0.6)"),this.setEvents()}get selectedNote(){return this.selectedSVGNote}get SelectedNotes(){return this.selectedSVGNotes}undisplayIndicator(){this.indicator.style={display:"none"},this.shadowIndicator.style={display:"none"},this.selectNotesIndicator.forEach((t,e,s)=>{t.style={display:"none"}})}displayIndicator(){this.indicator.style={display:"unset"},this.shadowIndicator.style={display:"unset"},this.selectNotesIndicator.forEach((t,e,s)=>{t.style={display:"unset"}})}resetIndicator(){this.selectedBlock=null,this.unselectNoteBlock()}setEvents(){this.controlTab.on("noteclick",(t,e,s,i)=>{this.selectNoteAndMoveIndicator(t,e,s),this.selectedSVGNote=this.controlTab.getSVGNote(t,e),this.unselectSVGNotes()}),this.controlTab.on("noteshiftclick",(t,e,s,i)=>{this.unselectSVGNotes(),this.controlTab.getSVGNote(t,e),this.selectedSVGNotes=this.controlTab.endsSelect(this.controlTab.noteIndex(this.selectedSVGNote),this.controlTab.noteIndex(this.controlTab.getSVGNote(t,e))),this.drawMultiSelectRect(this.selectedSVGNotes)}),this.controlTab.on("keydown",(t,e)=>{if(" "===t.toLowerCase()||isNaN(Number(t)))this.inputBlock=0;else if(this.selectedBlock){let e=10*this.inputBlock+Number(t);this.inputBlock=e<40?e:Number(t),this.controlTab.setStringDataOfNote(this.selectedBlock.section,this.selectedBlock.note,this.selectedBlock.string,this.inputBlock),this.controlTab.render()}if("d"===t.toLowerCase()||"arrowright"===t.toLowerCase()){if(this.selectedSVGNotes.length>0){let t=this.selectedSVGNotes[this.selectedSVGNotes.length-1].blockGroup[0];this.selectedBlock={section:t.section,note:t.note,string:t.string},this.unselectSVGNotes()}this.selectedBlock&&this.selectRight(this.selectedBlock,this.controlTab)}if("a"===t.toLowerCase()||"arrowleft"===t.toLowerCase()){if(this.selectedSVGNotes.length>0){let t=this.selectedSVGNotes[0].blockGroup[0];this.selectedBlock={section:t.section,note:t.note,string:t.string},this.unselectSVGNotes()}this.selectedBlock&&this.selectLeft(this.selectedBlock,this.controlTab)}if("w"===t.toLowerCase()||"arrowup"===t.toLowerCase()){if(this.selectedSVGNotes.length>0){let t=this.selectedSVGNotes[this.selectedSVGNotes.length-1].blockGroup[0];this.selectedBlock={section:t.section,note:t.note,string:t.string},this.unselectSVGNotes()}this.selectedBlock&&this.selectUp(this.selectedBlock,this.controlTab)}if("s"===t.toLowerCase()||"arrowdown"===t.toLowerCase()){if(this.selectedSVGNotes.length>0){let t=this.selectedSVGNotes[this.selectedSVGNotes.length-1].blockGroup[0];this.selectedBlock={section:t.section,note:t.note,string:t.string},this.unselectSVGNotes()}this.selectedBlock&&this.selectDown(this.selectedBlock,this.controlTab)}if("i"===t.toLowerCase()){if(this.selectedSVGNotes.length>0&&(this.selectedBlock={section:this.selectedSVGNotes[0].section,note:this.selectedSVGNotes[0].note,string:0},this.unselectSVGNotes()),this.selectedBlock){let t=this.insertEmptyNote(this.selectedBlock);this.controlTab.render(),this.selectNoteAndMoveIndicator(t.section,t.note,t.string)}this.controlTab.render()}if("delete"===t.toLowerCase()||"backspace"===t.toLowerCase())if(this.selectedSVGNotes.length>0){for(let t=this.selectedSVGNotes.length-1;t>=0;t--)this.controlTab.deleteNote(this.selectedSVGNotes[t].section,this.selectedSVGNotes[t].note),this.controlTab.render();this.unselectSVGNotes()}else this.selectedBlock&&this.deleteNoteBlock(this.selectedBlock,this.controlTab);if("+"===t.toLowerCase()&&this.changeNoteLength("+"),"-"===t.toLowerCase()&&this.changeNoteLength("-"),(110===e||190===e)&&this.selectedBlock){let t=this.controlTab.getNoteData(this.selectedBlock.section,this.selectedBlock.note);Math.floor(t[0])===t[0]?t[0]=2*t[0]/3:t[0]=3*t[0]/2,this.controlTab.setNoteData(this.selectedBlock.section,this.selectedBlock.note,t),this.controlTab.render(),this.selectNoteAndMoveIndicator(this.selectedBlock.section,this.selectedBlock.note,this.selectedBlock.string)}}),this.controlTab.on("mouseovernote",(t,e,s,i)=>{this.shadowIndicator.cx=i[0],this.shadowIndicator.cy=i[1]}),this.controlTab.on("mouseoutnote",(t,e,s,i)=>{this.shadowIndicator.cx=-20,this.shadowIndicator.cy=-20}),this.controlTab.on("mousedown",(t,e)=>{e+=this.controlTab.domElement.scrollTop,null!=this.dragNDropSection&&this.dragNDropSection.remove(),this.dragNDropSection=this.controlTab.tabCanvas.layers.ui.createRect(0,0,0,0,5,"rgba(255, 50, 0, 0.6)"),this.dragStartPos=[t,e],this.dragNDropSection.style={display:"none"},this.mouseDown=!0,this.mouseMove=!1,this.unselectSVGNotes()}),this.controlTab.on("mousemove",(t,e)=>{e+=this.controlTab.domElement.scrollTop,this.mouseDown&&(Math.sqrt(Math.pow(t-this.dragStartPos[0],2)+Math.pow(e-this.dragStartPos[1],2))>1&&(this.mouseMove=!0,this.selectedBlock&&this.controlTab.isBlankNote(this.selectedBlock.section,this.selectedBlock.note)&&(this.controlTab.deleteNote(this.selectedBlock.section,this.selectedBlock.note),this.unselectNoteBlock(),this.controlTab.render())),this.mouseMove&&(t-this.dragStartPos[0]>=0?this.dragNDropSection.x=this.dragStartPos[0]:this.dragNDropSection.x=t,e-this.dragStartPos[1]>=0?this.dragNDropSection.y=this.dragStartPos[1]:this.dragNDropSection.y=e,this.dragNDropSection.setShape(Math.abs(t-this.dragStartPos[0]),Math.abs(e-this.dragStartPos[1])),this.dragNDropSection.style={display:"unset"}))}),this.controlTab.on("mouseup",(t,e)=>{if(e+=this.controlTab.domElement.scrollTop,this.mouseDown=!1,this.mouseMove){let s,i,n,o;this.dragNDropSection.remove(),t>=this.dragStartPos[0]?(s=this.dragStartPos[0],n=t):(s=t,n=this.dragStartPos[0]),e>=this.dragStartPos[1]?(i=this.dragStartPos[1],o=e):(i=e,o=this.dragStartPos[1]),this.selectedSVGNotes=this.controlTab.areaSelect(s,i,n,o),this.drawMultiSelectRect(this.selectedSVGNotes)}}),this.controlTab.on("sectionhover",t=>{this.controlTab.tabCanvas.layers.ui.hightLightSection(t)}),this.controlTab.on("sectionhout",t=>{this.controlTab.tabCanvas.layers.ui.hideSectionIndicator(t)}),this.controlTab.on("sectionclick",(t,e)=>{this.selectNoteAndMoveIndicator(t,this.controlTab.getNoteNumberOfSection(t)-1,e),this.selectedBlock&&this.selectedBlock.section===t&&this.selectedBlock.note===this.controlTab.getNoteNumberOfSection(t)-1&&this.controlTab.isBlankNote(t,this.selectedBlock.note)||(this.controlTab.addNote(t,-1,new i),this.controlTab.render(),this.selectNoteAndMoveIndicator(t,this.controlTab.getNoteNumberOfSection(t)-1,e))})}selectNoteAndMoveIndicator(t,e,s){let i=this.controlTab.getSectionLeftTopPos(t),n=this.controlTab.getNotePosition(t,e,s);return-1!==n[0]&&(!this.selectedBlock||this.selectedBlock.section==t&&this.selectedBlock.note==e||this.controlTab.getNoteNumberOfSection(this.selectedBlock.section)>1&&this.controlTab.isBlankNote(this.selectedBlock.section,this.selectedBlock.note)&&(this.controlTab.deleteNote(this.selectedBlock.section,this.selectedBlock.note),this.controlTab.render(),this.selectedBlock.section===t&&this.selectedBlock.note<e&&e--,i=this.controlTab.getSectionLeftTopPos(t),n=this.controlTab.getNotePosition(t,e,s)),this.setSelectNote(t,e,s),this.setIndicator(n),this.controlTab.adjustPostion(i[1]),!0)}setSelectNote(t,e,s){this.selectedBlock={section:t,note:e,string:s}}setIndicator(t){this.indicator.cx=t[0],this.indicator.cy=t[1]}changeNoteLength(t){let e;if("+"===t)e=1;else{if("-"!==t)return;e=0}if(this.selectedBlock){let t=[1,2,4,8,16,32],s=this.controlTab.getNoteData(this.selectedBlock.section,this.selectedBlock.note);for(let i=1-e;i<t.length-e;i++)if(t[i]>=s[0]){s[0]=t[i-1+2*e],this.controlTab.setNoteData(this.selectedBlock.section,this.selectedBlock.note,s),this.controlTab.render(),this.selectNoteAndMoveIndicator(this.selectedBlock.section,this.selectedBlock.note,this.selectedBlock.string);break}}}selectRight(t,e){let s=this.selectNoteAndMoveIndicator(t.section,t.note+1,t.string);s||(e.isBlankNote(t.section,t.note)?(s=this.selectNoteAndMoveIndicator(t.section+1,0,t.string))||(e.addNote(t.section+1,0,new i),e.render(),this.selectNoteAndMoveIndicator(t.section+1,0,t.string)):(e.addNote(t.section,t.note+1,new i),e.render(),this.selectNoteAndMoveIndicator(t.section,t.note+1,t.string)))}selectLeft(t,e){0===t.note?e.isBlankNote(t.section,t.note)?t.section>0&&this.selectNoteAndMoveIndicator(t.section-1,this.controlTab.getNoteNumberOfSection(t.section-1)-1,t.string):(e.addNote(t.section,0,new i),e.render(),this.selectNoteAndMoveIndicator(t.section,0,t.string)):this.selectNoteAndMoveIndicator(t.section,t.note-1,t.string)}selectUp(t,e){t.string>0&&this.selectNoteAndMoveIndicator(t.section,t.note,t.string-1)}selectDown(t,e){t.string<5&&this.selectNoteAndMoveIndicator(t.section,t.note,t.string+1)}insertEmptyNote(t){return this.controlTab.isBlankNote(this.selectedBlock.section,this.selectedBlock.note)||(this.controlTab.addNote(this.selectedBlock.section,this.selectedBlock.note,new i),this.selectedBlock={section:this.selectedBlock.section,note:this.selectedBlock.note,string:this.selectedBlock.string}),this.selectedBlock}deleteNoteBlock(t,e){this.controlTab.setStringDataOfNote(t.section,t.note,t.string,-1),e.render()}drawMultiSelectRect(t){let e=[];for(let s=0;s<t.length;s++)e.push(t[s].line);let s=e.filter(function(t,e,s){return e==s.indexOf(t)});if(t.length>0){this.unselectNoteBlock();let e=[];for(let i=0;i<s.length;i++){let n=t.filter(function(t,e,n){return t.line==s[i]});e.push({lineIndex:s[i],notes:n})}for(let t=0;t<e.length;t++){let s=e[t].notes[0].blockGroup[0],i=e[t].notes[e[t].notes.length-1].blockGroup[e[t].notes[e[t].notes.length-1].blockGroup.length-1];this.selectNotesIndicator.push(this.controlTab.tabCanvas.layers.ui.createRect(s.x-this.selectNotesIndicatorPadding,s.y-this.selectNotesIndicatorPadding,i.x-s.x+2*this.selectNotesIndicatorPadding,i.y-s.y+2*this.selectNotesIndicatorPadding,5,"rgba(255, 182, 45, 0.6)"))}}}unselectSVGNotes(){this.selectedSVGNotes=[],this.selectNotesIndicator.length>0&&this.selectNotesIndicator.forEach((t,e,s)=>{t.remove()})}unselectNoteBlock(){this.selectedBlock=null,this.setIndicator([-20,-20])}}(O);O.attach(document.getElementById("slimtab")),document.addEventListener("keydown",t=>{[32,37,38,39,40].includes(t.keyCode)&&(t.preventDefault(),t.returnValue=!1)}),O.render();let F,R=new class{constructor(t){this.startTimeOffset=0,this.timeOffset=0,this.bpm=120,this.rawData=[],this.lengthPerBeat=4,this.chordInterval=-.2*this.bpm+84,this.beatInnerCount=[0,0],this.isWorking=!1,t&&(this.bpm=t),this.callbacks=new r(["packNote","data"])}receiveData(t,e,s,i){this.isWorking&&(this.rawData.push([t,e,i+40+this.timeOffset]),this.receiveInterval||(this.receiveInterval=setTimeout(this.packNote.bind(this),this.chordInterval)),this.callbacks.data.callAll(t,e,i))}addPackListener(t){this.callbacks.packNote.push(t)}addDataListener(t){this.callbacks.data.push(t)}getTime(){return performance.now()}get milliSecondPerBeat(){return 6e4/this.bpm}setBpm(t){this.bpm=t}activate(){this.isWorking=!0}deactivate(){this.init(),this.isWorking=!1}init(){this.rawData=[],this.beatInnerCount=[0,0],this.noteRawData=null}packNote(){let t=[-1,-1,-1,-1,-1,-1];for(let e=0;e<this.rawData.length;e++)t[this.rawData[e][0]]=this.rawData[e][1];let e=this.timeToBeatCount(this.rawData[0][2]+this.startTimeOffset);if(this.beatInnerCount[0]!=.5*Math.floor(e/.5)&&(this.beatInnerCount[0]=.5*Math.floor(e/.5),e!==.5*Math.floor(e/.5)?this.beatInnerCount[1]=1:this.beatInnerCount[1]=0),this.beatInnerCount[1]++,this.beatInnerCount[1]>2)return this.preTime=(this.beatInnerCount[0]+.25)*this.milliSecondPerBeat-this.startTimeOffset,this.receiveInterval=null,void(this.rawData=[]);if(this.noteRawData){let t,s=e-this.timeToBeatCount(this.preTime+this.startTimeOffset);s<=0?(t=16,this.preTime=(this.timeToBeatCount(this.rawData[0][2]+this.startTimeOffset)+.25)*this.milliSecondPerBeat-this.startTimeOffset):(t=this.lengthPerBeat/s,this.preTime=this.rawData[0][2]),this.noteRawData.noteValue=t,this.noteRawData.userData=null,this.callbacks.packNote.callAll(this.noteRawData)}else{if(0!==e){let t=e,s=this.lengthPerBeat/t;this.noteRawData=new i({noteValue:s,stringContent:[-1,-1,-1,-1,-1,-1]}),this.callbacks.packNote.callAll(this.noteRawData)}this.preTime=this.rawData[0][2]}this.noteRawData=new i({noteValue:4,stringContent:t,userData:"undefined-value"}),this.rawData=[],this.receiveInterval=null,this.callbacks.packNote.callAll(this.noteRawData)}timeToBeatCount(t){let e=[3,1],s=this.milliSecondPerBeat/(2*(e[0]+e[1])),i=[s*e[0]/2];for(let t=0;t<3;t++)i.push(i[t]+e[(t+1)%2]*s);let n=t/this.milliSecondPerBeat,o=Math.floor(n),r=(n-o)*this.milliSecondPerBeat,l=4;for(let t=0;t<4;t++)if(r<i[t]){l=t;break}return o+.25*l}};R.timeOffset=40;let Q=new class{constructor(t){this.bpm=120,this.timeOffset=.05,this.audioStartTime=-1,this.startTime=-1,this.mode="",this.scheduleOsc=[],this.beatCount=0,this.startTimeOffset=.1,this.audioContext=new AudioContext,t&&(this.bpm=t),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1.5,this.gainNode.connect(this.audioContext.destination),this.base64toAudioBuffer(P).then(t=>this.sound=t),this.base64toAudioBuffer(D).then(t=>this.sound2=t)}startTick(){if(this.clearScheduleOsc(),this.mode="click",!this.tickTimer){let t=60/this.bpm;this.audioContext.suspend();let e=this.audioContext.currentTime+this.startTimeOffset;this.nextTime=e+t,this.tickTimer=-1*setTimeout(()=>{this.tick(),this.tickTimer=setInterval(()=>this.tick(),1e3*t)},1e3*t-1e3*this.timeOffset),this.makeSound(e),this.audioContext.resume()}}stopTick(){this.tickTimer<0?clearTimeout(-1*this.tickTimer):clearInterval(this.tickTimer),this.audioContext.suspend(),this.clearScheduleOsc(),this.tickTimer=null,this.startTime=-1,this.audioStartTime=-1,this.beatCount=0}setBpm(t){this.bpm=t}scheduleTick(t,e="normal"){if("click"===this.mode&&(this.stopTick(),this.mode="schedule"),this.startTime>=0)return void console.warn("Cannot schedule tick before stop tick(call stopTick())");let s=1e3*this.audioContext.currentTime+t;this.audioStartTime<0&&(this.audioStartTime=s),"normal"===e?this.makeSound(s/1e3):this.makeSound(s/1e3,this.sound2)}play(){return this.startTime>=0?-1:this.scheduleOsc.length<1?(console.warn("no tick is scheduled"),-1):(this.startTime=this.audioStartTime-1e3*this.audioContext.currentTime+performance.now(),this.audioContext.resume(),this.startTime)}getStartTime(){return this.startTime}base64toAudioBuffer(t){return fetch(t).then(t=>t.arrayBuffer()).then(t=>this.audioContext.decodeAudioData(t))}clearScheduleOsc(){for(let t=0;t<this.scheduleOsc.length;t++)this.scheduleOsc[t].disconnect();this.scheduleOsc=[]}tick(){let t=this.audioContext.currentTime,e=60/this.bpm;t>this.nextTime?(this.timeOffset+=.05,this.makeSound(t+this.timeOffset),this.nextTime=t+this.timeOffset+e):(this.makeSound(this.nextTime),this.nextTime+=e),t=this.audioContext.currentTime,4===this.beatCount&&(this.startTime=performance.now()+1e3*(this.nextTime-t)),this.scheduleOsc.length>10&&this.scheduleOsc.shift()}makeSound(t,e=this.sound){let s=this.audioContext.createBufferSource();return this.beatCount%4==0&&"click"===this.mode&&(e=this.sound2),s.buffer=e,s.connect(this.gainNode),s.start(t),s.stop(t+.05),this.beatCount++,this.scheduleOsc.push(s),s}}(120);C.enumerate().then(t=>{t.length>0&&(F=t[0],t[0].on("pick",(t,e,s,i)=>{R.startTimeOffset=-Q.getStartTime(),R.receiveData(t,e,s,i)}),t[0].on("message",t=>{R.startTimeOffset=-Q.getStartTime();let e=V.noteKeyToFrequency(t.data[1]),[s,i]=V.frequencyToStringData(e);R.receiveData(s,i,t.data[2],t.timeStamp)}))}),R.addPackListener(t=>{"undefined-value"===t.userData?(O.isSectionFull(O.getSectionNumber()-1)?O.addNote(-1,-1,t):O.addNote(O.getSectionNumber()-1,-1,t),O.render()):(O.deleteNote(O.getSectionNumber()-1,O.getNoteNumberOfSection(O.getSectionNumber()-1)-1),O.instrumentNoteInput(B,t)),O.adjustPostion(O.getSectionLeftTopPos(O.getSectionNumber()-1)[1])}),R.addDataListener((t,e,s)=>{K.onPluck(t,e,performance.now()-30-50)});let H=0,z=document.getElementById("metronome"),j=document.getElementById("metronome-bpm");j.addEventListener("change",()=>{Q.setBpm(Number(j.value)),R.setBpm(Number(j.value)),document.getElementById("bpm-display").innerHTML=j.value,console.log(j.value)}),z.onclick=function(t){0==H?(Q.startTick(),z.style.background="#e99415",R.activate(),H=1):(Q.stopTick(),z.style.background="",R.deactivate(),H=0)};let U;window.gg=()=>{U=setInterval(function(){O.instrumentNoteInput(B,new i([8,[-1,-1,-1,4,-1,6],null]))},100)},window.gx=()=>{clearInterval(U)},O.on("noteclick",(t,e,s)=>{document.getElementById("section-idx").innerText=function(t,e){return("000000000"+t).substr(-e)}(String(t+1),3)+"."});let Y=new class{constructor(){this.ctx=new AudioContext,this.sampleRate=32e3,this.startAt=0,this.wsL=new WebSocket("ws://localhost:9002/LiCAP/L/subscribe"),this.wsR=new WebSocket("ws://localhost:9002/LiCAP/R/subscribe"),this.wsL.binaryType="arraybuffer",this.wsR.binaryType="arraybuffer"}play(){this.wsL.onmessage=t=>{let e=new Float32Array(t.data),s=this.ctx.createBufferSource(),i=this.ctx.createBuffer(1,e.length,this.sampleRate);i.getChannelData(0).set(e),s.buffer=i,s.connect(this.ctx.destination),this.startAt=Math.max(this.ctx.currentTime,this.startAt),s.start(this.startAt),this.startAt+=i.duration}}};document.getElementById("playstream").addEventListener("click",()=>{Y.play()}),console.log(O);let K=new class{constructor(t,e,s){this.bpm=120,this.timeSignature={upper:4,lower:4},this.isRepeat=!1,this.indicatorShapes=[],this.resultUIElements=[],this.indicatorColor="rgba(255, 209, 81, 0.6)",this.correctResultColor="rgba(0, 163, 250, 0.9)",this.wrongResultColor="rgba(250, 80, 0, 0.9)",this.whiteColor="rgba(255, 255, 255, 0.9)",this.playFlag=!1,this.startFlag=!1,this.timer=new I,this.playLag=.05,this.selectedTimeSum=0,this.metronomeOn=!1,this.playIter=0,this.maxPracticeTimes=1,this.openStringTunes=[40,45,50,55,59,64],this.deviceStartTime=0,this.collectPractContent=[],this.anlyzeMethod="pluck",this.loadedSheet=[],this.preMetronome=!0,this.correctTolerance=100,this.devices=[],this.controlTab=t,this.editor=e,this.metronome=s,this.setEvents()}play(){if(this.startFlag=!0,this.controlTab.inEdit=!1,this.playIter==this.maxPracticeTimes||this.playIter>0&&!this.isRepeat)return void this.stop();if(this.loadedSheet=this.loadSheetNote(),this.clearAnalyzeUI(),this.playIter>0&&"whole"==this.anlyzeMethod){this.practiceAnalyze(this.collectPractContent)}let t;if(0==this.playIter&&(this.metronome.stopTick(),this.timer.stop()),this.editor.SelectedNotes.length>0)this.isRepeat=!0,t=this.sortBySectionId(this.editor.SelectedNotes);else{this.isRepeat=!1;let e=this.controlTab.headToEndSelect(this.controlTab.noteIndex(this.editor.selectedNote));t=this.sortBySectionId(e)}let e=0,s=0,i=[];this.editor.undisplayIndicator(),t.forEach((t,n,o)=>{let r=this.sectionTwoEnds(t),l=0;if(0==n&&(null==this.nowPlaySectionIndicator?this.nowPlaySectionIndicator=this.controlTab.tabCanvas.layers.ui.createRect(r.x1,r.y1,r.x2-r.x1,r.y2-r.y1,2,this.indicatorColor):(this.nowPlaySectionIndicator.setPos(r.x1,r.y1),this.nowPlaySectionIndicator.setShape(r.x2-r.x1,r.y2-r.y1)),0!=t[0].note)){let e=0,i=this.controlTab.getSectionData(t[0].section);for(let s=0;s<t[0].note;s++)e+=this.timeSignature.lower/i[s][0];e%1!=0&&(s=this.timeSignature.lower/(1-e%1))}let a=0;if(t.forEach((t,e,s)=>{let i=this.controlTab.getNoteData(t.section,t.note);a+=this.noteValeu2Time(i.noteValue),l+=this.timeSignature.lower/i.noteValue}),e+=a,i.push(l),1==o.length)this.timer.registerDelay(this.stopNowPlaySectionIndicator.bind(this),1e3*a,1);else if(o.length>1&&n<o.length-1){let t=this.sectionTwoEnds(o[n+1]);this.indicatorShapes.push({x:t.x1,y:t.y1,width:t.x2-t.x1,height:t.y2-t.y1}),this.timer.registerDelay(this.pushNowPlaySectionIndicator.bind(this),1e3*e,1)}n==o.length-1&&this.timer.registerDelay(this.play.bind(this),1e3*e,1)});let n=0;if(0==this.playIter){let e=1;this.isRepeat&&(e=this.maxPracticeTimes);for(let o=0;o<e;o++)i.forEach((e,i,o)=>{0==this.selectedTimeSum&&0==n&&(n+=this.playLag);let r=60*e/this.bpm;console.log(e),this.registerSectionMetronome(this.selectedTimeSum+n,e,0==t[i][0].note,s),n+=r})}this.selectedTimeSum+=n,this.playIter+=1,this.timer.start(),this.metronomeOn||(this.metronome.play(),this.metronomeOn=!0),this.deviceStartTime=performance.now()}stop(){if(this.timer.stop(),this.stopNowPlaySectionIndicator(),this.indicatorShapes=[],this.metronome.stopTick(),this.metronomeOn=!1,this.selectedTimeSum=0,this.playIter=0,this.editor.displayIndicator(),this.playFlag=!1,this.startFlag=!1,this.controlTab.inEdit=!0,"whole"==this.anlyzeMethod){let t=this.practiceAnalyze(this.collectPractContent);this.drawAnalyzeUI(this.controlTab.tabCanvas.layers.ui,t)}}bindDevice(){}onPluck(t,e,s){let i={channel:t,note:e,time:s};if(this.startFlag&&(this.collectPractContent.push(i),"pluck"==this.anlyzeMethod)){let t=this.practiceAnalyze([i]);this.drawAnalyzeUI(this.controlTab.tabCanvas.layers.ui,t)}}loadSheetNote(){let t=[],e=0,s=0;return this.controlTab.notes.forEach((i,n,o)=>{i.forEach((i,o,r)=>{t.push({section:n,note:o,noteId:s,noteValue:i.noteValue,noteTime:e,stringContent:i[1],style:i[2]}),e+=1e3*this.noteValeu2Time(i.noteValue),s+=1})}),t}playPracticeSectionIndicator(){this.timer.start()}setPracticeSectionIndicator(t){let e=0;t.forEach((t,s,i)=>{let n=this.sectionTwoEnds(t),o=0;0==s&&(null==this.nowPlaySectionIndicator?this.nowPlaySectionIndicator=this.controlTab.tabCanvas.layers.ui.createRect(n.x1,n.y1,n.x2-n.x1,n.y2-n.y1,2,this.indicatorColor):(this.nowPlaySectionIndicator.setPos(n.x1,n.y1),this.nowPlaySectionIndicator.setShape(n.x2-n.x1,n.y2-n.y1)));let r=0;if(t.forEach((t,e,s)=>{let i=this.controlTab.getNoteData(t.section,t.note);r+=this.noteValeu2Time(i.noteValue),o+=this.timeSignature.lower/i.noteValue}),e+=r,1==i.length)this.timer.registerDelay(this.stopNowPlaySectionIndicator.bind(this),1e3*r,1);else if(i.length>1&&s<i.length-1){let t=this.sectionTwoEnds(i[s+1]);this.indicatorShapes.push({x:t.x1,y:t.y1,width:t.x2-t.x1,height:t.y2-t.y1}),this.timer.registerDelay(this.pushNowPlaySectionIndicator.bind(this),1e3*e,1)}s==i.length-1&&this.timer.registerDelay(this.play.bind(this),1e3*e,1)})}pushNowPlaySectionIndicator(){let t=this.indicatorShapes.shift();this.nowPlaySectionIndicator.setPos(t.x,t.y),this.nowPlaySectionIndicator.setShape(t.width,t.height)}stopNowPlaySectionIndicator(){null!=this.nowPlaySectionIndicator&&(this.nowPlaySectionIndicator.remove(),this.nowPlaySectionIndicator=null)}getSetionBeats(t){let e=0;if(0!=t[0].note){let s=0,i=this.controlTab.getSectionData(t[0].section);for(let e=0;e<t[0].note;e++)s+=this.timeSignature.lower/i[e][0];s%1!=0&&(e=this.timeSignature.lower/(1-s%1))}}noteValeu2Time(t){return 0==t?0:this.timeSignature.lower/t/(this.bpm/60)}registerSectionMetronome(t,e,s,i){null==i&&(i=0);let n=this.timeSignature.lower/i;n==1/0&&(n=0),s?this.metronome.scheduleTick(1e3*t,"strong"):this.metronome.scheduleTick(1e3*(t+this.noteValeu2Time(i)),"normal"),console.log(e-n);for(let s=1;s<Math.floor(e-n);s++)this.metronome.scheduleTick(1e3*(t+s*this.noteValeu2Time(this.timeSignature.lower)+this.noteValeu2Time(i)),"normal")}setEvents(){this.controlTab.on("keydown",t=>{" "===t.toLowerCase()&&(this.controlTab.inEdit=!1,this.playFlag=!this.playFlag,this.playFlag?(this.editor.undisplayIndicator(),this.preMetronome?(this.registerSectionMetronome(this.playLag,this.timeSignature.upper,!0),this.timer.registerDelay(this.play.bind(this),this.timeSignature.upper*this.noteValeu2Time(this.timeSignature.lower)*1e3),this.metronome.play(),this.timer.start()):this.play()):this.stop(),this.clearAnalyzeUI()),"q"===t.toLowerCase()&&this.onPluck(0,0,performance.now())}),this.controlTab.on("mousedown",(t,e)=>{this.clearAnalyzeUI()})}sortBySectionId(t){let e=[];for(let s=0;s<t.length;s++)e.push(t[s].section);let s=e.filter(function(t,e,s){return e==s.indexOf(t)}),i=[];for(let e=0;e<s.length;e++){let n=t.filter(function(t,i,n){return t.section==s[e]});i.push(n)}return i}sectionTwoEnds(t){let e=t[0].blockGroup.length,s={x:t[0].blockGroup[0].x,y:t[0].blockGroup[0].y},i={x:t[t.length-1].blockGroup[e-1].x,y:t[t.length-1].blockGroup[e-1].y};if(0==t[0].note){let e=this.controlTab.tabCanvas.layers.ui.sectionIndicator[t[0].section];s={x:e.x,y:e.y}}if(t[t.length-1].note==this.controlTab.notes[t[t.length-1].section].length-1){let e=this.controlTab.tabCanvas.layers.ui.sectionIndicator[t[t.length-1].section];i={x:e.x+e.width,y:e.y+e.height}}return{x1:s.x,y1:s.y,x2:i.x,y2:i.y}}practiceAnalyze(t){if(t.length<1)return[];if(this.loadedSheet.length<1)return[];let e=[];return t.forEach((t,s,i)=>{let n,o,r,l=this.timeNoteMapping(t.time-this.deviceStartTime,this.loadedSheet);console.log(t.time-this.deviceStartTime),console.log(performance.now()-this.deviceStartTime),o=Math.abs(t.time-this.deviceStartTime-(this.loadedSheet[l].noteTime+this.playLag))<=this.correctTolerance?"correct":t.time-this.deviceStartTime-(this.loadedSheet[l].noteTime+this.playLag)>0?"drag":"rush",r=t.note==this.loadedSheet[l].stringContent[t.channel],n={section:this.loadedSheet[l].section,note:this.loadedSheet[l].note,channel:t.channel,playedNote:t.note,sheetNote:this.loadedSheet[l].stringContent[t.channel],playedTime:t.time-this.deviceStartTime,sheetTime:this.loadedSheet[l].noteTime,noteId:this.loadedSheet[l].noteId,timeResult:o,noteResult:r},e.push(n)}),e}drawAnalyzeUI(t,e){e.forEach((e,s,i)=>{let[n,o]=this.controlTab.getNotePosition(e.section,e.note,e.channel),r=this.controlTab.getNoteData(e.section,e.note).noteValue,l=0;"drag"==e.timeResult?l=1/(r/this.timeSignature.lower)*30:"rush"==e.timeResult&&(l=1/(r/this.timeSignature.lower)*-30);let a=t.createEllipse(n+l,o,8,8),h=t.createText(n+l,o+5,e.playedNote.toString(),"middle");"correct"==e.timeResult&&e.noteResult?(h.fill=this.correctResultColor,a.fill=this.correctResultColor):(h.fill=this.whiteColor,a.fill=this.wrongResultColor),this.resultUIElements.push(h),this.resultUIElements.push(a)})}clearAnalyzeUI(){this.resultUIElements.forEach((t,e,s)=>{t.remove()})}timeNoteMapping(t,e){let s=0;for(let i=0;i<e.length;i++){if(t>s&&t<=e[i].noteTime)return Math.abs(t-s)>Math.abs(t-e[i].noteTime)?i:i-1;if(t>e[e.length-1].noteTime)return e.length-1;s=e[i].noteTime}}}(O,_,Q);document.addEventListener("keydown",t=>{" "===t.key.toLowerCase()&&(R.activate(),setTimeout(()=>F.resetTimer(),2e3)),"r"!=t.key&&"e"!=t.key||(R.startTimeOffset=-Q.getStartTime(),R.receiveData(1,5,2,t.timeStamp-50))}),document.getElementById("save-file").addEventListener("click",function(){let t=document.createElement("a");t.setAttribute("download","tablature.tab"),t.style.display="none",t.setAttribute("href",`data:text/plain;charset=utf-8,${JSON.stringify(O.notes)}`),document.body.append(t),t.click(),document.body.removeChild(t)});let W=document.getElementById("load-file");W.style.display="none",W.addEventListener("change",t=>{let e=new FileReader;e.onload=t=>{let e=JSON.parse(t.target.result);_.resetIndicator(),O.setData(e),O.render()},e.readAsText(W.files[0]),W.value=""}),document.getElementById("load-f").addEventListener("click",()=>{W.click()})}]);
//# sourceMappingURL=demo.js.map