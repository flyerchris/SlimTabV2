var demo=function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";var i;s.r(e),function(t){t.setAttributes=function(t,e){for(let s in e)t.setAttribute(s,e[s])},t.setStyle=function(t,e){for(let s in e)t.style.setProperty(s,e[s])};const e={C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11},s=/^([CDEFGAB]#?)([0-9])$/;t.noteToDecimal=function(t){let i=s.exec(t);return 3!=i.length?-1:e[i[1]]+12*(Number(i[2])+1)}}(i||(i={}));class n{constructor(){this.funcs=[]}callAll(...t){this.funcs.forEach(e=>{e(...t)})}push(t){this.funcs.push(t)}}class o{constructor(t){t.forEach(t=>{this[t]=new n})}}class r{constructor(t,e,s,i){this.domelement=t,this.word=e,this.wordBack=s,this.extendRect=i}set x(t){this._x=t,this.word.x=t,this.wordBack.x=t,this.extendRect.x=t}get x(){return this._x}set y(t){this._y=t,this.word.y=t+4,this.wordBack.y=t+4}get y(){return this._y}set section(t){this._section=t}get section(){return this._section}set note(t){this._note=t}get note(){return this._note}set string(t){this._string=t}get string(){return this._string}set line(t){this._line=t}get line(){return this._line}}class l{constructor(t,e,s){this.blockGroup=[],this.lineGroup=[],this.domelement=t,this.blockGroup=e,this.lineGroup=s}set section(t){this._section=t}get section(){return this._section}set note(t){this._note=t}get note(){return this._note}set line(t){this._line=t}get line(){return this._line}}class a{constructor(){this.linker=[],this.domElement=document.createElementNS("http://www.w3.org/2000/svg","g")}clear(){this.domElement.innerHTML=""}createRect(t,e,s,n,o,r,l){const a=document.createElementNS("http://www.w3.org/2000/svg","rect");return i.setAttributes(a,{x:`${t}`,y:`${e}`,width:`${s}`,height:`${n}`,"stroke-width":`${o}`,fill:r}),l?l.appendChild(a):this.domElement.appendChild(a),new c(a)}createEllipse(t,e,s,n,o){const r=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return i.setAttributes(r,{cx:`${t}`,cy:`${e}`,rx:`${s}`,ry:`${n}`}),o?o.appendChild(r):this.domElement.appendChild(r),new d(r)}createText(t,e,s,n,o){const r=document.createElementNS("http://www.w3.org/2000/svg","text");return i.setAttributes(r,{x:`${t}`,y:`${e}`,"text-anchor":`${n}`}),r.innerHTML=`${s}`,o?o.appendChild(r):this.domElement.appendChild(r),new g(r)}createLine(t,e,s,n,o,r,l){const a=document.createElementNS("http://www.w3.org/2000/svg","line");return i.setAttributes(a,{x1:`${t}`,y1:`${e}`,x2:`${s}`,y2:`${n}`,stroke:`${r}`,"stroke-width":`${o}`}),l?l.appendChild(a):this.domElement.appendChild(a),new u(a)}createLinker(t){let e=document.createElementNS("http://www.w3.org/2000/svg","path");return t?t.appendChild(e):this.domElement.appendChild(e),i.setAttributes(e,{fill:"white"}),this.linker.push(e),e}}class h{constructor(t){this._domElement=t}remove(){this._domElement.remove()}get domElement(){return this._domElement}set style(t){i.setStyle(this.domElement,t)}}class c extends h{constructor(t){super(t)}setPos(t,e){i.setAttributes(this.domElement,{x:`${t}`,y:`${e}`})}setShape(t,e){i.setAttributes(this.domElement,{width:`${t}`,height:`${e}`})}set x(t){i.setAttributes(this.domElement,{x:`${t}`})}get x(){return Number(this.domElement.getAttribute("x"))}set y(t){i.setAttributes(this.domElement,{y:`${t}`})}get y(){return Number(this.domElement.getAttribute("y"))}set width(t){i.setAttributes(this.domElement,{width:`${t}`})}get width(){return Number(this.domElement.getAttribute("width"))}set height(t){i.setAttributes(this.domElement,{height:`${t}`})}get height(){return Number(this.domElement.getAttribute("height"))}set strokeWidth(t){i.setAttributes(this.domElement,{"stroke-width":`${t}`})}get strokeWidth(){return Number(this.domElement.getAttribute("stroke-width"))}set fill(t){i.setAttributes(this.domElement,{fill:`${t}`})}get fill(){return this.domElement.getAttribute("fill")}}class d extends h{constructor(t){super(t)}setPos(t,e){i.setAttributes(this.domElement,{cx:`${t}`,cy:`${e}`})}setShape(t,e,s,n){i.setAttributes(this.domElement,{rx:`${s}`,ry:`${n}`})}set cx(t){i.setAttributes(this.domElement,{cx:`${t}`})}get cx(){return Number(this.domElement.getAttribute("cx"))}set cy(t){i.setAttributes(this.domElement,{cy:`${t}`})}get cy(){return Number(this.domElement.getAttribute("cy"))}set rx(t){i.setAttributes(this.domElement,{rx:`${t}`})}get rx(){return Number(this.domElement.getAttribute("rx"))}set ry(t){i.setAttributes(this.domElement,{ry:`${t}`})}get ry(){return Number(this.domElement.getAttribute("ry"))}set fill(t){i.setAttributes(this.domElement,{fill:`${t}`})}get fill(){return this.domElement.getAttribute("fill")}}class u extends h{constructor(t){super(t)}setEndPoints(t,e,s,n){i.setAttributes(this.domElement,{x1:`${t}`,y1:`${e}`,x2:`${s}`,y2:`${n}`})}set x1(t){i.setAttributes(this.domElement,{x1:`${t}`})}get x1(){return Number(this.domElement.getAttribute("x1"))}set y1(t){i.setAttributes(this.domElement,{y1:`${t}`})}get y1(){return Number(this.domElement.getAttribute("y1"))}set x2(t){i.setAttributes(this.domElement,{x2:`${t}`})}get x2(){return Number(this.domElement.getAttribute("x2"))}set y2(t){i.setAttributes(this.domElement,{y2:`${t}`})}get y2(){return Number(this.domElement.getAttribute("y2"))}set stroke(t){i.setAttributes(this.domElement,{stroke:`${t}`})}get stroke(){return this.domElement.getAttribute("stroke")}set strokeWidth(t){i.setAttributes(this.domElement,{"stroke-width":`${t}`})}get strokeWidth(){return Number(this.domElement.getAttribute("stroke-width"))}}class g extends h{constructor(t){super(t)}setPos(t,e){i.setAttributes(this.domElement,{x:`${t}`,y:`${e}`})}set x(t){i.setAttributes(this.domElement,{x:`${t}`})}get x(){return Number(this.domElement.getAttribute("x"))}set y(t){i.setAttributes(this.domElement,{y:`${t}`})}get y(){return Number(this.domElement.getAttribute("y"))}set anchor(t){i.setAttributes(this.domElement,{"text-anchor":`${t}`})}get anchor(){return this.domElement.getAttribute("text-anchor")}set text(t){this.domElement.innerHTML=`${t}`}get text(){return this.domElement.innerHTML}set strokeWidth(t){i.setAttributes(this.domElement,{"stroke-width":`${t}`})}get strokeWidth(){return Number(this.domElement.getAttribute("stroke-width"))}}class A extends a{constructor(){super(),this.noteElements=[],i.setAttributes(this.domElement,{"data-layer":"NoteLayer"})}createNote(){const t=document.createElementNS("http://www.w3.org/2000/svg","g"),e=document.createElementNS("http://www.w3.org/2000/svg","g"),s=[],n=document.createElementNS("http://www.w3.org/2000/svg","g"),o=[];o.push(this.createLine(0,0,0,0,1,"white",n));for(let t=0;t<3;t++)o.push(this.createLine(0,0,0,0,2,"white",n));t.append(n);for(let t=0;t<6;t++){const t=document.createElementNS("http://www.w3.org/2000/svg","g"),n=this.createRect(0,0,0,0,0,"rgba(0, 0, 0, 0)",t),o=this.createText(0,0,"","middle",t),l=this.createText(0,0,"","middle",t);i.setAttributes(t,{"stroke-width":"0",stroke:"black",style:"cursor:pointer;"}),o.strokeWidth=3,o.style={font:"12px Sans-serf"},l.style={font:"12px Sans-serif",fill:"#fff"},e.append(t),s.push(new r(t,l,o,n))}return t.append(e),this.noteElements.push(new l(t,s,o)),this.domElement.append(t),t}}class m extends a{constructor(){super(),this.row=[],this.bar=[],i.setAttributes(this.domElement,{"data-layer":"SheetLayer"})}createRow(t,e,s,n,o,r){let l=document.createElementNS("http://www.w3.org/2000/svg","g"),a=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttributes(a,{x:`${t}`,y:`${e}`,style:"fill: rgba(255, 255, 255, 0.09)",width:`${2*n[0]+s}`,height:`${2*n[1]+5*o}`}),l.appendChild(a),t+=n[0],e+=n[1];for(let i=0;i<6;i++){let n=s;this.createLine(t,e+i*o,t+n,e+i*o,2,"rgba(255, 255, 255, 0.24)",l)}this.drawRowTitle(t-30,e,l),this.createLine(t,e,t,e+5*o,2,"rgba(255, 255, 255, 0.24)",this.domElement);for(let t=0;t<r;t++){let t=this.createLine(0,e,0,e+5*o,2,"rgba(255, 255, 255, 0.24)",this.domElement);this.bar.push(t)}return this.domElement.append(l),this.row.push(l),l}drawRowTitle(t,e,s){let i=document.createElementNS("http://www.w3.org/2000/svg","g");return i.innerHTML=`\n        <text style="fill:#959595;font:17px arial;">\n            <tspan x='${t+10}' y='${e+26}'>T</tspan>\n            <tspan x='${t+10}' y='${e+22+26}'>A</tspan>\n            <tspan x='${t+10}' y='${e+44+26}'>B</tspan>\n        </text>\n        `,s&&s.append(i),i}}class b extends a{constructor(){super(),this.sectionIndicator=[],i.setAttributes(this.domElement,{"data-layer":"UILayer"})}createSectionIndicator(){let t=this.createRect(0,0,0,0,0,"rgba(0, 255, 255, 0.13)");return t.style={display:"none"},this.sectionIndicator.push(t),t}}class N{constructor(){this.background=new a,this.sheet=new m,this.notes=new A,this.foreground=new a}get flattened(){return[this.background,this.sheet,this.notes,this.foreground]}}class p extends N{constructor(){super(),this.ui=new b}get flattened(){return[this.background,this.ui,this.sheet,this.notes,this.foreground]}}class w{constructor(t){this.layerType=t,this.layers=new t,this.domElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),i.setStyle(this.domElement,{"user-select":"none"}),this.layers.flattened.forEach(t=>this.domElement.appendChild(t.domElement))}}var P=function(t,e,s,i){return new(s||(s=Promise))(function(n,o){function r(t){try{a(i.next(t))}catch(t){o(t)}}function l(t){try{a(i.throw(t))}catch(t){o(t)}}function a(t){t.done?n(t.value):new s(function(e){e(t.value)}).then(r,l)}a((i=i.apply(t,e||[])).next())})};class f{constructor(t){this.device=t,this.callbacks=new o(["pick"]),this.device.onmidimessage=this.onMessage.bind(this)}on(t,e){t in this.callbacks&&this.callbacks[t].push(e)}static isSupported(){return navigator.requestMIDIAccess}static enumerate(){return P(this,void 0,void 0,function*(){let t=[];if(f.isSupported()){let e=yield navigator.requestMIDIAccess();for(let s of e.inputs.values())if(console.log(s.name),s.name.match(/STM32 Virtual ComPort/)){t.push(new f(s)),console.log(`use ${s.name}`);break}}return t})}onMessage(t){let e=15&t.data[0];switch(t.data[0]>>4&15){case 8:break;case 9:this.callbacks.pick.callAll(e,t.data[1],t.data[2]/255,t.timeStamp)}}}class y{constructor(t){this.bpm=120,this.timeOffset=.05,this.audioContext=new AudioContext,t&&(this.bpm=t),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=.3,this.gainNode.connect(this.audioContext.destination),fetch(E).then(t=>t.arrayBuffer()).then(t=>this.audioContext.decodeAudioData(t)).then(t=>this.sound=t)}startTick(){if(!this.tickTimer){let t=60/this.bpm;this.audioContext.suspend();let e=this.audioContext.currentTime;this.nextTime=e+t,this.tickTimer=-1*setTimeout(()=>{this.tick(),this.tickTimer=setInterval(()=>this.tick(),1e3*t)},1e3*t-1e3*this.timeOffset),this.makeSound(e),this.audioContext.resume()}}stopTick(){this.tickTimer<0?clearTimeout(-1*this.tickTimer):clearInterval(this.tickTimer),this.tickTimer=null}setBpm(t){this.bpm=t}tick(){let t=this.audioContext.currentTime,e=60/this.bpm;t>this.nextTime?(this.timeOffset+=.05,this.makeSound(t+this.timeOffset),this.nextTime=t+this.timeOffset+e):(this.makeSound(this.nextTime),this.nextTime+=e)}makeSound(t){let e=this.audioContext.createBufferSource();return e.buffer=this.sound,e.connect(this.gainNode),e.start(t),e.stop(t+.05),e}}let E="data:audio/wav;base64,UklGRigHAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0YQQHAADw/wAAGAAgAOD+AP0I/Bj7OPr4+Uj5gPhw+BD4gPeQ96j5qPyo/vj9GPwo++j8wP9oAbAC6AOIBBADgADI/kj96PtI+9AB0AtgEYAZyCK4JlAimBkgBmjwAOUI3gDZKNco3LjlEO2o/CAQqBr4FqAM2ASw+njvCOpA+JAPOBzYDejzUOYw8PACmA1IEGAQkA8IC2AE8P44+rj2iPnQ7iDaQNOQ3QjscO6g57DjCOlA8qDzQPHY8QjzGPswBoANSBfAIGgooD51V+Ve1VDAOmgoGCAoHqggqCCYG7gQ4AJo+bj5uPEQ4jDZ2NNQ0HjPwMTbttOyy7kIweDJCNWI4YDwsPwQAwAQqB7II5AaiAxwAwgJ4BUgF6AM8APYAeAEiAZABej3oOjw4hjfGN4Q4ejo4PNQ+xj80Pzg/ggHoBboIegnWDBANZg2yCyQINAgiCcIKxAoQB9YFfAP2AbI/0D9wPqI90j0UOfQ2xjVeNUA3LDfMOXg6uDosOYg6GDrmPIQ+xAAMAoQFYAZCBRoD9gOMA+QD/APcApgEKgbYB3AFigOuAOg77jfgNwY4UDpSO/w7+DvAPE49WD++AV4Avj4cPKQ+qgKmBXgHigiWB+oFagM8AjYFZghUCLgHngX2BC4CEgC2ADQ/3AB8ANgA8j7uPMg71joyONA5ODowO6I8nD4aP44AbAKwBVgGvAY+BNwD+Ab6CzIM/gnYBUICugDsAIwBEgEIAEw/dD2OPEA8MDn4N7Q1+jVUNoQ51j02Pp4/Dj9CP6YBYAOaBLoETATkBRgF7AYcBZgD0ADwPlQ+Dj8OAFQ/wD5APUA/PAHwBCIEdAJqP+w/LgDmA1wFYAZUBewEJgI6ASABcgL8BPQFmgTwA0oCfAEWPxQ9dDzWPYw+jD9kPOQ5gjiaOag7oD2kPyI/iD9UPRA7MjrGPMY/GABCAAI+2j3iABQDsgUYBJICxgCYPz49hD22Pnw/iACMAPYBqAMgA8YDYAIKAaQATj+YP64+7D26PJ49bD70ADAA0ACGP5Y/CgAiAVYCWgJgAWo/xD9mP8gA5gF0AZgCkANyAxgCvgDSP2Y9jjzsPRg+Bj8YP5A/mD64Pao+TgA+ATIAYD6iPVI+EgCSAsIDwgNoAeYAtgA4P+YAVAEgAUgBCACaALAAAj+oPwg+Tj2WPVY9tj5EP6A/1j7+PUI9MjyYPKI9Oj0gPPQ8mj14Pmw/RABSAMYA5ADKAWIBggHcAbgBFAEmARYBIgAOPug+Bj54Pr4/IgAiAR4BmgGiAVgBKgDeAMQA0ACUAF4ADgBaAMABVgEIAIwALD/cABoAagBKAGAAOj+6Pwo/PD9+AAIA4gE8AVIBjgEgABo/Sj7aPkA+Wj5EPog+0D7APpA+XD6mPxI/jD/4P54/Uj86PsQ/Jj8IP14/cj9yP6IABgCQAS4BqgHGAcgBrgE+AHA/uD8CPyI++j7qP3Q/zgBKAE4AFj/sP5Y/mD+EABoAnADaAGI/dj6+PvI/8gCkATgBUgGsAXoBDAE4APQA3AD0AJoAjgCmAIQA/ACkAGw/4j+iP8QAvADGANoAHD+6P0Y/oj+wP6w/qj+QP9QADgBYAAo/oj86Pvg+1D70PpI+8j8wP5oAOD/KP2Q+jD5cPgQ+Pj36Pcw+OD4CPmA+Kj3MPeg9wD6gP3I/9gAwAEYAiACSAJQAqgCoAOoBDgG+AdQCQAKCAs4DIgM+AqgCCAHiAYwBgAGcAWIBOgD+AJoARAAQACoAdgCeALoAIj/YP1Y+jj4ePhg+mD8WP1Y/fj8yPyw/HD8cPtI+iD64Pqw+yj8kPwQ/bD9oP3I/MD76Ps4/eD+uABgAsgCCAIoAXgAMABoAOAAKAIQBGAFkAUQBQAEyAIYAtgBuAFwAVgBcAGAAZABqAFAATgAKAAYAbABCAG4/+D+2P5A/6j/CACAAPgAKAHYAGgAOABAAEAAGAD4/9j/sP9w/+D/+ADQARAC8AGYAWAAcP4A/eD8yP3Q/lD/UP8g/5D+mP3I/LD8MP3I/Vj+mP5o/vj9wP3o/fD9CP6A/lD/0P+w/yj/QP6I/cD8ePz4/PD9EP8IAGgA8ACwAQgCwAFAAagAoAAwAZABKAIYA7AD8AMIBKADkAJgAdgA4AAQASABAAEIAbAA+P9Y/4D/GAB4AAgASP84/xD/cP4A/iD+iP7A/rD+oP7Q/qD/gADAAOD/yP4w/lj+0P4g/0D/cP/Q//D/oP8o/0j/0P8gADgAYABQAFgAiACQABAAcP8w/5D/MACQACgAcP8Q/6j+KP7o/cj9yP0o/kD/aADwAHgBCAIwAtABQAGgAIgA4AD4AKAAWAB4AFAAsP8I/6D+wP5I/9j/EAB4/5D++P2o/Uj9OP04/sD/8ADIAUgCeAKQAg==";const D=function(t,e,s,i){t.notes[s]=t.notes[s].slice(0,i+1);let n=0;for(let e=0;e<=i;e++)n+=t.lengthPerBeat/t.notes[s][e][0];if(n>=t.beatPerSection)t.notes.splice(s+1,0,[]),t.notes[s+1].push(e);else if(n+t.lengthPerBeat/e[0]>t.beatPerSection){let i=t.beatPerSection-n,o=t.lengthPerBeat/(t.lengthPerBeat/e[0]-i);i=t.lengthPerBeat/i,t.notes[s].push([i,e[1],"linkStart"]),t.notes.splice(s+1,0,[]),t.notes[s+1].push([o,e[1],"linkEnd"])}else{let i=1-n%1;if(i>=t.lengthPerBeat/e[0])t.notes[s].push(e);else{let n=t.lengthPerBeat/e[0]-i;t.notes[s].push([t.lengthPerBeat/i,e[1],"linkStart"]),t.notes[s].push([t.lengthPerBeat/n,e[1],"linkEnd"])}}};let k=new class{constructor(t){this.lengthPerBeat=4,this.beatPerSection=4,this.lineWidth=800,this.sectionPerLine=2,this.stringPadding=16,this.linePerPage=20,this.lineMargin=42,this.linePadding=[32,14],this.lineDistance=90,this.sectionAddNoteNumber=16,this.linkerElement=[],this.sectionIndicatorElement=[],this.startPosition=[this.lineMargin+this.linePadding[0]+20,120+this.linePadding[1]],this.lineStartPosition=[this.lineMargin,120],this.height=1e3,Object.assign(this,t),this.tabCanvas=new w(p);let e=this.lineWidth+2*this.linePadding[0]+84;i.setAttributes(this.tabCanvas.domElement,{width:`${e}`,height:`${this.height}`}),this.domElement=document.createElement("div"),this.domElement.append(this.tabCanvas.domElement),i.setStyle(this.domElement,{width:`${e+20}px`,height:"600px","overflow-y":"auto","overflow-x":"hidden"}),this.callbacks=new o(["noteclick","keydown","mouseovernote","mouseoutnote","mousedown","mousemove","mouseup"]),this.tabCanvas.domElement.addEventListener("focus",()=>{}),this.tabCanvas.domElement.addEventListener("keydown",this.onKeydown.bind(this)),this.tabCanvas.domElement.addEventListener("mousedown",this.onMouseDown.bind(this)),this.tabCanvas.domElement.addEventListener("mousemove",this.onMouseMove.bind(this)),this.tabCanvas.domElement.addEventListener("mouseup",this.onMouseUp.bind(this))}setData(t){this.notes=t}getNoteData(t,e){return this.notes[t][e]}setNoteData(t,e,s){this.notes[t][e]=s}deleteNote(t,e){this.notes[t].splice(e,1)}addNote(t,e,s){t>=this.notes.length&&(t=this.notes.length,this.notes.push([])),this.notes[t].splice(e,0,s)}isBlankNote(t,e){for(let s=0;s<6;s++)if(-1!=this.notes[t][e][1][s])return!1;return!0}getNotePosition(t,e,s=0){let i=0;if(-1==t&&(t=this.notes.length-1),-1==e&&(e=this.notes[t].length-1),t>=this.notes.length||t<-1||e>=this.notes[t].length||e<-1||s>5||s<0)return[-1,-1];for(let e=0;e<t;e++)i+=this.notes[e].length;i+=e;let n=this.tabCanvas.layers.notes.noteElements[i].blockGroup[s];return[n.x,n.y]}getNoteNumberOfSection(t){return-1==t&&(t=this.notes.length-1),this.notes[t].length}getSectionNumber(){return this.notes.length}instrumentNoteInput(t,e,s=-1,i=-1){-1==s&&(s=this.notes.length-1),-1==i&&(i=this.notes[s].length-1),t(this,e,s,i),this.render()}attach(t){t.append(this.domElement)}areaSelect(t,e,s,i){let n=this.tabCanvas.layers.notes.noteElements;var o=[];let r,l;for(let r=0;r<n.length;r++)for(let l=0;l<6;l++)n[r].blockGroup[l].x>=t&&n[r].blockGroup[l].x<=s&&n[r].blockGroup[l].y>=e&&n[r].blockGroup[l].y<=i&&(o.push(r),console.log(r));return console.log(o),r=Math.min(...o),l=Math.max(...o),console.log(n.slice(r,l+1)),n.slice(r,l+1)}render(){this.setAllLine();let[t,e,s]=this.calNoteRawData();this.setSectionIndicator(s),this.setAllNoteElementData(t),this.setLinker(e)}on(t,e){t in this.callbacks&&this.callbacks[t].push(e)}setAllLine(){let t=Math.ceil(this.notes.length/this.sectionPerLine),e=this.tabCanvas.layers.sheet.row.length;for(let s=e;s<t;s++){let t=this.lineStartPosition[0],e=this.lineStartPosition[1]+(5*this.stringPadding+this.lineDistance)*s;this.tabCanvas.layers.sheet.createRow(t,e,this.lineWidth,this.linePadding,this.stringPadding,this.sectionPerLine)}for(let s=t;s<e;s++)i.setStyle(this.tabCanvas.layers.sheet.row[s],{display:"none"});for(let e=0;e<t;e++)i.setStyle(this.tabCanvas.layers.sheet.row[e],{display:"unset"})}setSectionIndicator(t){if(t.length>this.sectionIndicatorElement.length){let e=t.length-this.sectionIndicatorElement.length;for(let t=0;t<e;t++)this.tabCanvas.layers.ui.createSectionIndicator()}for(let e=0;e<t.length;e++){let s=t[e][1][0]-t[e][0][0],i=5*this.stringPadding;this.tabCanvas.layers.ui.sectionIndicator[e].x=t[e][0][0],this.tabCanvas.layers.ui.sectionIndicator[e].y=t[e][0][1],this.tabCanvas.layers.ui.sectionIndicator[e].width=s,this.tabCanvas.layers.ui.sectionIndicator[e].height=i}}calNoteRawData(){let[t,e]=this.startPosition,s=[],i=(this.beatPerSection,this.lengthPerBeat,[]),n=[],o=0;s.push([0,0,0,null,null,0,0]);for(let r=0;r<this.notes.length;r++){let l=Math.floor(r/this.sectionPerLine),a=0;o=0;for(let t=0;t<this.sectionPerLine;t++)this.notes[l*this.sectionPerLine+t]?a+=this.notes[l*this.sectionPerLine+t].length+this.sectionAddNoteNumber:a+=this.sectionAddNoteNumber;let h=this.lineWidth*(this.notes[r].length+this.sectionAddNoteNumber)/a,c=0;for(let t=0;t<this.notes[r].length;t++)c+=this.lengthPerBeat/this.notes[r][t][0];let d=(h-20)/c;r%this.sectionPerLine==0&&(t=this.startPosition[0],0!=r&&(e+=5*this.stringPadding+this.lineDistance));let u=[[t-20,e],[0,e]],g=t+h;u[1][0]=g-20,this.tabCanvas.layers.sheet.bar[r].x1=g-20,this.tabCanvas.layers.sheet.bar[r].x2=g-20,n.push(u);for(let n=0;n<this.notes[r].length;n++){let l,a=this.notes[r][n],h=this.lengthPerBeat/a[0];o+h/this.lengthPerBeat>=.25?(l=this.calculateTail(s[s.length-1][2],a[0],-1,d),o=0):(l=this.calculateTail(s[s.length-1][2],a[0],o,d),o+=h/this.lengthPerBeat);let c=d*this.lengthPerBeat/a[0];s.push([t,e,a[0],a[1],l,r,n]),"linkStart"!==a[2]&&"linkEnd"!==a[2]||i.push([t,e]),t+=c}t=g}return s.shift(),[s,i,n]}calculateTail(t,e,s,i){let n=i*this.lengthPerBeat/t*-1,o=8;if(-1==s&&(o=-8),0==s){if(8==e)return[8,0,0];if(16==e)return[8,8,0];if(32==e)return[8,8,8]}else if(8==e){if(8==t||16==t||32==t)return[n,0,0]}else if(16==e){if(8==t)return[n,o,0];if(16==t||32==t)return[n,n,0]}else if(32==e){if(8==t)return[n,o,o];if(16==t)return[n,n,o];if(32==t)return[n,n,n]}return[0,0,0]}setAllNoteElementData(t){let e=this.tabCanvas.layers.notes.noteElements,s=t.length-e.length;for(let t=0;t<s;t++)this.tabCanvas.layers.notes.createNote(),e[e.length-1].blockGroup.forEach((t,e)=>{t.domelement.addEventListener("click",this.onNoteClicked.bind(this)),t.domelement.addEventListener("mouseover",this.onMouseOverNote.bind(this)),t.domelement.addEventListener("mouseout",this.onMouseOutNote.bind(this)),t.string=e,i.setAttributes(t.domelement,{"data-string":`${e}`})});for(let s=0;s<t.length;s++)i.setStyle(e[s].domelement,{display:"unset"}),s!=t.length-1&&t[s+1][0]>t[s][0]?this.setNoteElementData(e[s],t[s],.7*(t[s+1][0]-t[s][0])):this.setNoteElementData(e[s],t[s],30);for(let s=t.length;s<e.length;s++)i.setStyle(e[s].domelement,{display:"none"})}setNoteElementData(t,e,s){this.setElementPosition(t,e[0],e[1],e[4],e[5],e[6],s),this.setChordVisiable(t,e[1],e[2],e[3])}setElementPosition(t,e,s,n,o,r,l){let a=Math.floor(o/this.sectionPerLine);t.lineGroup[0].x1=e,t.lineGroup[0].y1=26+s+5*this.stringPadding,t.lineGroup[0].x2=e,t.lineGroup[0].y2=s,t.lineGroup[1].x1=e,t.lineGroup[1].y1=25+s+5*this.stringPadding,t.lineGroup[1].x2=e+n[0],t.lineGroup[1].y2=25+s+5*this.stringPadding,t.lineGroup[2].x1=e,t.lineGroup[2].y1=21+s+5*this.stringPadding,t.lineGroup[2].x2=e+n[1],t.lineGroup[2].y2=21+s+5*this.stringPadding,t.lineGroup[3].x1=e,t.lineGroup[3].y1=17+s+5*this.stringPadding,t.lineGroup[3].x2=e+n[2],t.lineGroup[3].y2=17+s+5*this.stringPadding;for(let n=0;n<6;n++)t.blockGroup[n].x=e,t.blockGroup[n].y=s+this.stringPadding*n,t.blockGroup[n].extendRect.y=s+this.stringPadding*(n-.5),t.blockGroup[n].extendRect.height=this.stringPadding,t.blockGroup[n].extendRect.width=l,i.setAttributes(t.blockGroup[n].domelement,{"data-x":`${e}`,"data-y":`${s+this.stringPadding*n}`,"data-line":`${a}`});t.section=o,t.note=r,t.line=a,i.setAttributes(t.domelement,{"data-section":`${o}`,"data-note":`${r}`}),t.blockGroup.forEach((t,e)=>{t.section=o,t.note=r,t.line=a,i.setAttributes(t.domelement,{"data-section":`${o}`,"data-note":`${r}`,"data-line":`${a}`})})}setChordVisiable(t,e,s,n){for(let e=0;e<6;e++)t.blockGroup[e].word.text=`${n[e]}`,t.blockGroup[e].wordBack.text=`${n[e]}`,-1==n[e]?i.setStyle(t.blockGroup[e].domelement,{display:"none"}):i.setStyle(t.blockGroup[e].domelement,{display:"block"});if(2==s)return void(t.lineGroup[0].y2=10+e+5*this.stringPadding);if(1==s)return void(t.lineGroup[0].y2=26+e+5*this.stringPadding);let o=6.5;for(let t=1;t<=6;t++)if(-1!=n[t-1]){o=t;break}t.lineGroup[0].y2=e+this.stringPadding*(o-1)}setLinker(t){let e=Math.floor(t.length/2),s=this.linkerElement.length;for(let t=0;t<e-s;t++)this.tabCanvas.layers.background.createLinker();for(let s=0;s<e;s++)this.setLinkerData(this.tabCanvas.layers.background.linker[s],t[2*s],t[2*s+1])}setLinkerData(t,e,s){let n=e[1]+31+5*this.stringPadding;if(e[1]!==s[1]){let o=e[0]+30,r=e[0],l=`M ${r} ${n} C ${r+4} ${n+15}, ${o-4} ${n+15}, ${o} ${n} C ${o-4} ${n+12}, ${r+4} ${n+12}, ${r} ${n} `;n=s[1]+31+5*this.stringPadding,l+=`M ${r=s[0]-30} ${n} C ${r+4} ${n+15}, ${(o=s[0])-4} ${n+15}, ${o} ${n} C ${o-4} ${n+12}, ${r+4} ${n+12}, ${r} ${n}`,i.setAttributes(t,{d:l})}else i.setAttributes(t,{d:`M ${e[0]} ${n} C ${e[0]+4} ${n+15}, ${s[0]-4} ${n+15}, ${s[0]} ${n} C ${s[0]-4} ${n+12}, ${e[0]+4} ${n+12}, ${e[0]} ${n}`})}onNoteClicked(t){let e=Number(t.currentTarget.dataset.section),s=Number(t.currentTarget.dataset.note),i=Number(t.currentTarget.dataset.string),n=[Number(t.currentTarget.dataset.x),Number(t.currentTarget.dataset.y)];this.callbacks.noteclick.callAll(e,s,i,n,t.currentTarget)}onKeydown(t){this.callbacks.keydown.callAll(t.key)}onMouseOverNote(t){let e=Number(t.currentTarget.dataset.section),s=Number(t.currentTarget.dataset.note),i=Number(t.currentTarget.dataset.string),n=[Number(t.currentTarget.dataset.x),Number(t.currentTarget.dataset.y)];this.callbacks.mouseovernote.callAll(e,s,i,n,t.currentTarget)}onMouseOutNote(t){let e=Number(t.currentTarget.dataset.section),s=Number(t.currentTarget.dataset.note),i=Number(t.currentTarget.dataset.string),n=[Number(t.currentTarget.dataset.x),Number(t.currentTarget.dataset.y)];this.callbacks.mouseoutnote.callAll(e,s,i,n,t.currentTarget)}onMouseDown(t){this.callbacks.mousedown.callAll(Number(t.x),Number(t.y))}onMouseMove(t){this.callbacks.mousemove.callAll(Number(t.x),Number(t.y))}onMouseUp(t){this.callbacks.mouseup.callAll(Number(t.x),Number(t.y))}};k.setData([[[4,[3,5,2,-1,-1,-1],null],[4,[-1,5,2,-1,-1,-1],null],[4,[-1,5,2,-1,-1,-1],null],[8,[-1,5,2,-1,-1,-1],null]],[[8,[-1,5,2,-1,-1,-1],null],[4,[-1,5,2,-1,-1,-1],null],[4,[-1,5,2,-1,-1,-1],null],[8,[-1,5,2,-1,-1,-1],null],[8,[-1,5,2,-1,-1,-1],null]]]);new class{constructor(t){this.inputBlock=0,this.mouseDown=!1,this.mouseMove=!1,this.selectNotesIndicator=[],this.selectNotesIndicatorPadding=8,this.controlTab=t,this.indicator=this.controlTab.tabCanvas.layers.ui.createEllipse(0,0,8,8),this.shadowIndicator=this.controlTab.tabCanvas.layers.ui.createEllipse(0,0,8,8),this.indicator.cx=-20,this.indicator.cy=-20,this.indicator.fill="rgb(255, 50, 0)",this.shadowIndicator.cx=-20,this.shadowIndicator.cy=-20,this.shadowIndicator.fill="rgba(255, 50, 0, 0.6)",this.dragNDropSection=this.controlTab.tabCanvas.layers.ui.createRect(0,0,0,0,0,"rgba(255, 50, 0, 0.6)"),this.setEvents()}setEvents(){this.controlTab.on("noteclick",(t,e,s,i)=>{this.setNoteClickEvent(t,e,s,i)}),this.controlTab.on("keydown",t=>{if(" "===t.toLowerCase()||isNaN(Number(t)))this.inputBlock=0;else if(this.selectNote){let e=10*this.inputBlock+Number(t);this.inputBlock=e<40?e:Number(t),this.selectNote.data[1][this.selectNote.string]=this.inputBlock,this.controlTab.setNoteData(this.selectNote.section,this.selectNote.note,this.selectNote.data),this.controlTab.render()}if(("d"===t.toLowerCase()||"arrowright"===t.toLowerCase())&&this.selectNote){let t=this.selectNoteAndMoveIndicator(this.selectNote.section,this.selectNote.note+1,this.selectNote.string);if(t)this.controlTab.isBlankNote(this.selectNote.section,this.selectNote.note-1)&&(this.controlTab.deleteNote(this.selectNote.section,this.selectNote.note-1),this.controlTab.render(),this.selectNoteAndMoveIndicator(this.selectNote.section,this.selectNote.note-1,this.selectNote.string));else if(this.controlTab.isBlankNote(this.selectNote.section,this.selectNote.note)){1!=this.controlTab.getNoteNumberOfSection(this.selectNote.section)&&(this.controlTab.deleteNote(this.selectNote.section,this.selectNote.note),this.controlTab.render()),(t=this.selectNoteAndMoveIndicator(this.selectNote.section+1,0,this.selectNote.string))||(this.controlTab.addNote(this.selectNote.section+1,0,[4,[-1,-1,-1,-1,-1,-1],null]),this.controlTab.render(),this.selectNoteAndMoveIndicator(this.selectNote.section+1,0,this.selectNote.string))}else this.controlTab.addNote(this.selectNote.section,this.selectNote.note+1,[4,[-1,-1,-1,-1,-1,-1],null]),this.controlTab.render(),this.selectNoteAndMoveIndicator(this.selectNote.section,this.selectNote.note+1,this.selectNote.string)}if(("a"===t.toLowerCase()||"arrowleft"===t.toLowerCase())&&this.selectNote)if(0===this.selectNote.note){if(this.selectNote.section>0){let t=this.controlTab.getNoteNumberOfSection(this.selectNote.section-1)-1;this.selectNoteAndMoveIndicator(this.selectNote.section-1,t,this.selectNote.string)}}else this.controlTab.isBlankNote(this.selectNote.section,this.selectNote.note)?(this.controlTab.deleteNote(this.selectNote.section,this.selectNote.note),this.controlTab.render(),this.selectNoteAndMoveIndicator(this.selectNote.section,this.selectNote.note-1,this.selectNote.string)):this.selectNoteAndMoveIndicator(this.selectNote.section,this.selectNote.note-1,this.selectNote.string);"w"!==t.toLowerCase()&&"arrowup"!==t.toLowerCase()||this.selectNote&&this.selectNote.string>0&&this.selectNoteAndMoveIndicator(this.selectNote.section,this.selectNote.note,this.selectNote.string-1),"s"!==t.toLowerCase()&&"arrowdown"!==t.toLowerCase()||this.selectNote&&this.selectNote.string<5&&this.selectNoteAndMoveIndicator(this.selectNote.section,this.selectNote.note,this.selectNote.string+1),"delete"!==t.toLowerCase()&&"backspace"!==t.toLowerCase()||this.selectNote&&(this.selectNote.data[1][this.selectNote.string]=-1,this.controlTab.setNoteData(this.selectNote.section,this.selectNote.note,this.selectNote.data),this.controlTab.render()),"+"===t.toLowerCase()&&this.changeNoteLength("-"),"-"===t.toLowerCase()&&this.changeNoteLength("+")}),this.controlTab.on("mouseovernote",(t,e,s,i)=>{this.shadowIndicator.cx=i[0],this.shadowIndicator.cy=i[1]}),this.controlTab.on("mouseoutnote",(t,e,s,i)=>{this.shadowIndicator.cx=-20,this.shadowIndicator.cy=-20}),this.controlTab.on("mousedown",(t,e)=>{null!=this.dragNDropSection&&this.dragNDropSection.remove(),this.dragNDropSection=this.controlTab.tabCanvas.layers.ui.createRect(0,0,0,0,5,"rgba(255, 50, 0, 0.6)"),this.dragStartPos=[t,e],this.dragNDropSection.style={display:"none"},this.mouseDown=!0,this.mouseMove=!1,this.selectNotesIndicator.length>0&&this.selectNotesIndicator.forEach((t,e,s)=>{t.remove()})}),this.controlTab.on("mousemove",(t,e)=>{this.mouseDown&&(Math.sqrt(Math.pow(t-this.dragStartPos[0],2)+Math.pow(e-this.dragStartPos[1],2))>2&&(this.mouseMove=!0),this.mouseMove&&(t-this.dragStartPos[0]>=0?this.dragNDropSection.x=this.dragStartPos[0]:this.dragNDropSection.x=t,e-this.dragStartPos[1]>=0?this.dragNDropSection.y=this.dragStartPos[1]:this.dragNDropSection.y=e,this.dragNDropSection.setShape(Math.abs(t-this.dragStartPos[0]),Math.abs(e-this.dragStartPos[1])),this.dragNDropSection.style={display:"unset"}))}),this.controlTab.on("mouseup",(t,e)=>{if(this.mouseDown=!1,this.mouseMove){let s,i,n,o;this.dragNDropSection.remove(),t>=this.dragStartPos[0]?(s=this.dragStartPos[0],n=t):(s=t,n=this.dragStartPos[0]),e>=this.dragStartPos[1]?(i=this.dragStartPos[1],o=e):(i=e,o=this.dragStartPos[1]),console.log("start point : "+s+" "+i),console.log("end point : "+n+" "+o),this.selectedNotes=this.controlTab.areaSelect(s,i,n,o);let r=[];for(let t=0;t<this.selectedNotes.length;t++)r.push(this.selectedNotes[t].line);let l=r.filter(function(t,e,s){return e==s.indexOf(t)});if(this.selectedNotes.length>0)if(1==l.length){let t=this.selectedNotes[0].blockGroup[0],e=this.selectedNotes[this.selectedNotes.length-1].blockGroup[this.selectedNotes[this.selectedNotes.length-1].blockGroup.length-1];this.selectNotesIndicator.push(this.controlTab.tabCanvas.layers.ui.createRect(t.x-this.selectNotesIndicatorPadding,t.y-this.selectNotesIndicatorPadding,e.x-t.x+2*this.selectNotesIndicatorPadding,e.y-t.y+2*this.selectNotesIndicatorPadding,5,"rgba(255, 182, 45, 0.6)"))}else{let t=[];for(let e=0;e<l.length;e++){let s=this.selectedNotes.filter(function(t,s,i){return t.line==l[e]});t.push({lineIndex:l[e],notes:s})}for(let e=0;e<t.length;e++){let s=t[e].notes[0].blockGroup[0],i=t[e].notes[t[e].notes.length-1].blockGroup[t[e].notes[t[e].notes.length-1].blockGroup.length-1];this.selectNotesIndicator.push(this.controlTab.tabCanvas.layers.ui.createRect(s.x-this.selectNotesIndicatorPadding,s.y-this.selectNotesIndicatorPadding,i.x-s.x+2*this.selectNotesIndicatorPadding,i.y-s.y+2*this.selectNotesIndicatorPadding,5,"rgba(255, 182, 45, 0.6)"))}}}})}selectNoteAndMoveIndicator(t,e,s){let i=this.controlTab.getNotePosition(t,e,s);return-1!==i[0]&&(this.setSelectNote(t,e,s),this.setIndicator(i),!0)}setNoteClickEvent(t,e,s,i){this.setSelectNote(t,e,s),this.setIndicator(i)}setSelectNote(t,e,s){this.selectNote={section:t,note:e,string:s,data:this.controlTab.getNoteData(t,e)}}setIndicator(t){this.indicator.cx=t[0],this.indicator.cy=t[1]}changeNoteLength(t){let e;if("+"===t)e=1;else{if("-"!==t)return;e=0}if(this.selectNote){let t=[1,2,4,8,16,32];for(let s=e;s<t.length-2+e;s++)if(t[s]===this.selectNote.data[0]){this.selectNote.data[0]=t[s+1-2*e],this.controlTab.setNoteData(this.selectNote.section,this.selectNote.note,this.selectNote.data),this.controlTab.render(),this.selectNoteAndMoveIndicator(this.selectNote.section,this.selectNote.note,this.selectNote.string);break}}}}(k);k.attach(document.getElementById("slimtab")),k.render();let x=new class{constructor(t){this.rawData=[],this.spb=500,this.lengthPerBeat=4,t&&(this.spb=6e4/t)}receiveData(t,e,s,i){this.rawData.push([t,e,i]),this.receiveInterval||(this.receiveInterval=setTimeout(this.packNote.bind(this),10))}setSendDataCallBack(t){this.sendData=t}packNote(){let t=[-1,-1,-1,-1,-1,-1];for(let e=0;e<this.rawData.length;e++)t[this.rawData[e][0]]=3;if(this.noteRawData){let t=this.rawData[0][2]-this.preTime;if(t>this.spb*this.lengthPerBeat)this.noteRawData[0]=1;else{let e=Math.log(this.spb/t)/Math.log(2),s=(Math.log(this.spb/(3*t)),Math.log(2),Math.pow(2,Math.ceil(e-.5)));this.noteRawData[0]=this.lengthPerBeat*s}this.sendData(-1,this.noteRawData)}this.preTime=this.rawData[0][2],this.noteRawData=[8,t,null],this.rawData=[],this.receiveInterval=null}};f.enumerate().then(t=>{t.length>0&&t[0].on("pick",x.receiveData.bind(x))});let C=null,v=0,I=document.getElementById("metronome");I.onclick=function(t){C||(C=new y(120)),0==v?(C.startTick(),I.style.background="#e99415",v=1):(C.stopTick(),I.style.background="",v=0)},k.instrumentNoteInput(D,[4,[-1,-1,-1,4,-1,6],null]),k.instrumentNoteInput(D,[4,[-1,-1,-1,4,-1,6],null],0,2),k.on("noteclick",(t,e,s)=>{document.getElementById("section-idx").innerText=function(t,e){return("000000000"+t).substr(-e)}(String(t+1),3)+"."});let B=new class{constructor(){this.ctx=new AudioContext,this.sampleRate=32e3,this.startAt=0,this.wsL=new WebSocket("ws://localhost:9002/LiCAP/L/subscribe"),this.wsR=new WebSocket("ws://localhost:9002/LiCAP/R/subscribe"),this.wsL.binaryType="arraybuffer",this.wsR.binaryType="arraybuffer"}play(){this.wsL.onmessage=t=>{let e=new Float32Array(t.data),s=this.ctx.createBufferSource(),i=this.ctx.createBuffer(1,e.length,this.sampleRate);i.getChannelData(0).set(e),s.buffer=i,s.connect(this.ctx.destination),this.startAt=Math.max(this.ctx.currentTime,this.startAt),s.start(this.startAt),this.startAt+=i.duration}}};document.getElementById("playstream").addEventListener("click",()=>{B.play()})}]);
//# sourceMappingURL=demo.js.map