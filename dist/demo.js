var demo=function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}return s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=0)}([function(t,e,s){"use strict";var i;s.r(e),function(t){t.setAttributes=function(t,e){for(let s in e)t.setAttribute(s,e[s])},t.setStyle=function(t,e){for(let s in e)t.style.setProperty(s,e[s])};const e={C:0,"C#":1,D:2,"D#":3,E:4,F:5,"F#":6,G:7,"G#":8,A:9,"A#":10,B:11},s=/^([CDEFGAB]#?)([0-9])$/;t.noteToDecimal=function(t){let i=s.exec(t);return 3!=i.length?-1:e[i[1]]+12*(Number(i[2])+1)}}(i||(i={}));class n{constructor(){this.funcs=[]}callAll(...t){this.funcs.forEach(e=>{e(...t)})}push(t){this.funcs.push(t)}}class o{constructor(t){t.forEach(t=>{this[t]=new n})}}class r{constructor(t,e,s,i){this.domelement=t,this.word=e,this.wordBack=s,this.extendRect=i}set x(t){this._x!==t&&(this._x=t,this.word.x=t,this.wordBack.x=t,this.extendRect.x=t)}get x(){return this._x}set y(t){this._y!==t&&(this._y=t,this.word.y=t+4,this.wordBack.y=t+4)}get y(){return this._y}set section(t){this._section=t}get section(){return this._section}set note(t){this._note=t}get note(){return this._note}set string(t){this._string=t}get string(){return this._string}set line(t){this._line=t}get line(){return this._line}}class l{constructor(t,e,s){this.blockGroup=[],this.lineGroup=[],this.domelement=t,this.blockGroup=e,this.lineGroup=s,this.tail8=new h,this.tail16=new c,this.tail32=new d,this.domelement.append(this.tail32.domElement,this.tail16.domElement,this.tail8.domElement)}set section(t){this._section=t}get section(){return this._section}set note(t){this._note=t}get note(){return this._note}set line(t){this._line=t}get line(){return this._line}}class a{constructor(){this._isShow=!0,this.domElement=document.createElementNS("http://www.w3.org/2000/svg","g"),i.setAttributes(this.domElement,{style:"fill: white;"})}setPosition(t,e){this._x===t&&this._y===e||(i.setStyle(this.domElement,{transform:`scale(0.08) translate(${t/.08}px,${e/.08}px)`}),this._x=t,this._y=e)}show(){this._isShow||(this._isShow=!0,i.setStyle(this.domElement,{display:"unset"}))}hide(){this._isShow&&(this._isShow=!1,i.setStyle(this.domElement,{display:"none"}))}}class h extends a{constructor(){super(),this.domElement.innerHTML='<use xlink:href="#stail8"></use>'}}class c extends a{constructor(){super(),this.domElement.innerHTML='<use xlink:href="#stail16"></use>'}}class d extends a{constructor(){super(),this.domElement.innerHTML='<use xlink:href="#stail32"></use>'}}class u{constructor(){this.linker=[],this.domElement=document.createElementNS("http://www.w3.org/2000/svg","g")}clear(){this.domElement.innerHTML=""}createRect(t,e,s,n,o,r,l){const a=document.createElementNS("http://www.w3.org/2000/svg","rect");return i.setAttributes(a,{x:`${t}`,y:`${e}`,width:`${s}`,height:`${n}`,"stroke-width":`${o}`,fill:r}),l?l.appendChild(a):this.domElement.appendChild(a),new m(a)}createEllipse(t,e,s,n,o){const r=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return i.setAttributes(r,{cx:`${t}`,cy:`${e}`,rx:`${s}`,ry:`${n}`}),o?o.appendChild(r):this.domElement.appendChild(r),new A(r)}createText(t,e,s,n,o){const r=document.createElementNS("http://www.w3.org/2000/svg","text");return i.setAttributes(r,{x:`${t}`,y:`${e}`,"text-anchor":`${n}`}),r.innerHTML=`${s}`,o?o.appendChild(r):this.domElement.appendChild(r),new p(r)}createLine(t,e,s,n,o,r,l){const a=document.createElementNS("http://www.w3.org/2000/svg","line");return i.setAttributes(a,{x1:`${t}`,y1:`${e}`,x2:`${s}`,y2:`${n}`,stroke:`${r}`,"stroke-width":`${o}`}),l?l.appendChild(a):this.domElement.appendChild(a),new b(a)}createLinker(t){let e=document.createElementNS("http://www.w3.org/2000/svg","path");return t?t.appendChild(e):this.domElement.appendChild(e),i.setAttributes(e,{fill:"white"}),this.linker.push(e),e}}class g{constructor(t){this._domElement=t}remove(){this._domElement.remove()}get domElement(){return this._domElement}set style(t){i.setStyle(this.domElement,t)}}class m extends g{constructor(t){super(t)}setPos(t,e){i.setAttributes(this.domElement,{x:`${t}`,y:`${e}`})}setShape(t,e){i.setAttributes(this.domElement,{width:`${t}`,height:`${e}`})}set x(t){this._x!==t&&(this._x=t,i.setAttributes(this.domElement,{x:`${t}`}))}get x(){return this._x}set y(t){this._y!==t&&(this._y=t,i.setAttributes(this.domElement,{y:`${t}`}))}get y(){return this._y}set width(t){this._width!==t&&(this._width=t,i.setAttributes(this.domElement,{width:`${t}`}))}get width(){return this._width}set height(t){this._height!==t&&(this._height=t,i.setAttributes(this.domElement,{height:`${t}`}))}get height(){return this._height}set strokeWidth(t){i.setAttributes(this.domElement,{"stroke-width":`${t}`})}get strokeWidth(){return Number(this.domElement.getAttribute("stroke-width"))}set fill(t){i.setAttributes(this.domElement,{fill:`${t}`})}get fill(){return this.domElement.getAttribute("fill")}}class A extends g{constructor(t){super(t)}setPos(t,e){i.setAttributes(this.domElement,{cx:`${t}`,cy:`${e}`})}setShape(t,e,s,n){i.setAttributes(this.domElement,{rx:`${s}`,ry:`${n}`})}set cx(t){this._cx!=t&&(this._cx=t,i.setAttributes(this.domElement,{cx:`${t}`}))}get cx(){return this._cx}set cy(t){this._cy!=t&&(this._cy=t,i.setAttributes(this.domElement,{cy:`${t}`}))}get cy(){return this._cy}set rx(t){this._rx!=t&&(this._rx=t,i.setAttributes(this.domElement,{rx:`${t}`}))}get rx(){return this._rx}set ry(t){this._ry!=t&&(this._ry=t,i.setAttributes(this.domElement,{ry:`${t}`}))}get ry(){return this._ry}set fill(t){i.setAttributes(this.domElement,{fill:`${t}`})}get fill(){return this.domElement.getAttribute("fill")}}class b extends g{constructor(t){super(t)}setEndPoints(t,e,s,n){i.setAttributes(this.domElement,{x1:`${t}`,y1:`${e}`,x2:`${s}`,y2:`${n}`})}set x1(t){this._x1!=t&&(this._x1=t,i.setAttributes(this.domElement,{x1:`${t}`}))}get x1(){return Number(this.domElement.getAttribute("x1"))}set y1(t){this._y1!=t&&(this._y1=t,i.setAttributes(this.domElement,{y1:`${t}`}))}get y1(){return Number(this.domElement.getAttribute("y1"))}set x2(t){this._x2!=t&&(this._x2=t,i.setAttributes(this.domElement,{x2:`${t}`}))}get x2(){return Number(this.domElement.getAttribute("x2"))}set y2(t){this._y2!=t&&(this._y2=t,i.setAttributes(this.domElement,{y2:`${t}`}))}get y2(){return Number(this.domElement.getAttribute("y2"))}set stroke(t){i.setAttributes(this.domElement,{stroke:`${t}`})}get stroke(){return this.domElement.getAttribute("stroke")}set strokeWidth(t){i.setAttributes(this.domElement,{"stroke-width":`${t}`})}get strokeWidth(){return Number(this.domElement.getAttribute("stroke-width"))}}class p extends g{constructor(t){super(t)}setPos(t,e){i.setAttributes(this.domElement,{x:`${t}`,y:`${e}`})}set x(t){this._x!=t&&(this._x=t,i.setAttributes(this.domElement,{x:`${t}`}))}get x(){return Number(this.domElement.getAttribute("x"))}set y(t){this._y!=t&&(this._y=t,i.setAttributes(this.domElement,{y:`${t}`}))}get y(){return Number(this.domElement.getAttribute("y"))}set anchor(t){i.setAttributes(this.domElement,{"text-anchor":`${t}`})}get anchor(){return this.domElement.getAttribute("text-anchor")}set text(t){this.domElement.innerHTML!==t&&(this.domElement.innerHTML=`${t}`)}get text(){return this.domElement.innerHTML}set strokeWidth(t){i.setAttributes(this.domElement,{"stroke-width":`${t}`})}get strokeWidth(){return Number(this.domElement.getAttribute("stroke-width"))}}class w extends u{constructor(){super(),this.noteElements=[],this.domElement.innerHTML='\n        <defs>\n            <path id="SVGTAIL8_1" d="M-4.728,151.313l10.303,2.061l39.153-33.854c0,0,20.543-24.318,23.338-67.708L70.34,0H43.846L22.061,78.012\n                l-33.854,20.901L-4.728,151.313z"/>\n        \t<clipPath id="SVGTAIL8_2">\n                <use xlink:href="#SVGTAIL8_1"  style="overflow:visible;"/>\n            </clipPath>\n\n            <path id="stail16"d="M67.37,59.776c2.698-19.84-2.806-39.01-7.124-58.173C60.138,1.127,59.523,0.765,58.825,0c0,3.411-0.317,6.266,0.054,9.029\n            c1.69,12.576,0.707,25.062-2.478,37.175c-5.494,20.897-15.163,39.32-35.394,49.69c-6.397,3.279-13.599,4.99-20.612,7.443\n            l-0.168,42.842c0.429-1.459,1.031-2.899,1.881-4.318c5.712-9.535,13.379-17.275,23.422-21.731\n            c11.728-5.203,21.372-12.634,29.432-22.407c0.486-0.59,1.154-1.029,2.017-1.782c-6.693,34.412-26.894,55.961-56.794,60.555\n            L0,203.874c1.634-4.092,2.518-8.621,4.922-12.148c5.906-8.664,14.092-14.797,23.71-19.308c16.597-7.786,30.016-19.532,35.085-37.498\n            c3.198-11.333,4.22-23.682,3.872-35.506C67.2,86.185,65.551,73.148,67.37,59.776z"/>\n        \n            <path id="stail8" style="clip-path:url(#SVGTAIL8_2);" d="M67.352,64.184c2.698-19.84-2.806-39.01-7.124-58.173\n            c-0.107-0.476-0.722-0.837-1.42-1.603c0,3.411-0.317,6.266,0.054,9.029c1.69,12.576,0.707,25.062-2.478,37.175\n            c-5.494,20.897-15.163,39.32-35.394,49.69c-6.397,3.279-13.599,4.99-20.612,7.443l-0.168,42.842\n            c0.429-1.459,1.031-2.899,1.881-4.318c5.712-9.535,13.379-17.275,23.422-21.731c11.728-5.203,21.372-12.634,29.432-22.407\n            c0.486-0.59,1.154-1.029,2.017-1.782c-6.693,34.412-26.894,55.961-56.794,60.555l-0.186,47.379\n            c1.634-4.092,2.518-8.621,4.922-12.148c5.906-8.664,14.092-14.797,23.71-19.308c16.597-7.786,30.016-19.532,35.085-37.498\n            c3.198-11.333,4.22-23.682,3.872-35.506C67.182,90.594,65.534,77.557,67.352,64.184z"/>\n\n            <path id="SVGID_1_" d="M-4.17,255.543l10.303,2.061l39.153-33.854c0,0,20.543-24.318,23.338-67.708l2.274-51.812H44.404\n                l-21.784,78.012l-33.854,20.901L-4.17,255.543z"/>\n            <clipPath id="SVGID_2_">\n                <use xlink:href="#SVGID_1_"  style="overflow:visible;"/>\n            </clipPath>\n            <g id="stail32">\n            <path d="M67.183,59.776c2.698-19.84-2.806-39.01-7.124-58.173C59.952,1.127,59.337,0.765,58.639,0c0,3.411-0.317,6.266,0.054,9.029\n\t\tc1.69,12.576,0.707,25.062-2.478,37.175c-5.494,20.897-15.163,39.32-35.394,49.69c-6.397,3.279-13.599,4.99-20.612,7.443\n\t\tl-0.168,42.842c0.429-1.459,1.031-2.899,1.881-4.318c5.712-9.535,13.379-17.275,23.422-21.731\n\t\tc11.728-5.203,21.372-12.634,29.432-22.407c0.486-0.59,1.154-1.029,2.017-1.782C50.101,130.352,29.9,151.901,0,156.495\n\t\tl-0.186,47.379c1.634-4.092,2.518-8.621,4.922-12.148c5.906-8.664,14.092-14.797,23.71-19.308\n\t\tc16.597-7.786,30.016-19.532,35.085-37.498c3.198-11.333,4.22-23.682,3.872-35.506C67.013,86.185,65.365,73.148,67.183,59.776z"/>\n            <path style="clip-path:url(#SVGID_2_);" d="M67.91,168.414c2.698-19.84-2.806-39.01-7.124-58.173\n\t\t\tc-0.107-0.476-0.722-0.837-1.42-1.603c0,3.411-0.317,6.266,0.054,9.029c1.69,12.576,0.707,25.062-2.478,37.175\n\t\t\tc-5.494,20.897-15.163,39.32-35.394,49.69c-6.397,3.279-13.599,4.99-20.612,7.443l-0.168,42.842\n\t\t\tc0.429-1.459,1.031-2.899,1.881-4.318c5.712-9.535,13.379-17.275,23.422-21.731c11.728-5.203,21.372-12.634,29.432-22.407\n\t\t\tc0.486-0.59,1.154-1.029,2.017-1.782c-6.693,34.412-26.894,55.96-56.794,60.555L0.54,312.512\n\t\t\tc1.634-4.092,2.518-8.621,4.922-12.148c5.906-8.664,14.092-14.797,23.71-19.308c16.597-7.786,30.016-19.532,35.085-37.498\n            c3.198-11.333,4.22-23.682,3.872-35.506C67.74,194.823,66.092,181.786,67.91,168.414z"/>\n            </g>\n        </defs>\n        ',i.setAttributes(this.domElement,{"data-layer":"NoteLayer"})}createNote(){const t=document.createElementNS("http://www.w3.org/2000/svg","g"),e=document.createElementNS("http://www.w3.org/2000/svg","g"),s=[],n=document.createElementNS("http://www.w3.org/2000/svg","g"),o=[];o.push(this.createLine(0,0,0,0,1,"white",n));for(let t=0;t<3;t++)o.push(this.createLine(0,0,0,0,2,"white",n));t.append(n);for(let t=0;t<6;t++){const t=document.createElementNS("http://www.w3.org/2000/svg","g"),n=this.createRect(0,0,0,0,0,"rgba(0, 0, 0, 0)",t),o=this.createText(0,0,"","middle",t),l=this.createText(0,0,"","middle",t);i.setAttributes(t,{"stroke-width":"0",stroke:"black",style:"cursor:pointer;"}),o.strokeWidth=3,o.style={font:"12px Sans-serf"},l.style={font:"12px Sans-serif",fill:"#fff"},e.append(t),s.push(new r(t,l,o,n))}return t.append(e),this.noteElements.push(new l(t,s,o)),this.domElement.append(t),t}}class y extends u{constructor(){super(),this.row=[],this.bar=[],i.setAttributes(this.domElement,{"data-layer":"SheetLayer"})}createRow(t,e,s,n,o,r){let l=document.createElementNS("http://www.w3.org/2000/svg","g"),a=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttributes(a,{x:`${t}`,y:`${e}`,style:"fill: rgba(255, 255, 255, 0.09)",width:`${2*n[0]+s}`,height:`${2*n[1]+5*o}`}),l.appendChild(a),t+=n[0],e+=n[1];for(let i=0;i<6;i++){let n=s;this.createLine(t,e+i*o,t+n,e+i*o,2,"rgba(255, 255, 255, 0.24)",l)}this.drawRowTitle(t-30,e,l),this.createLine(t,e,t,e+5*o,2,"rgba(255, 255, 255, 0.24)",this.domElement);for(let t=0;t<r;t++){let t=this.createLine(0,e,0,e+5*o,2,"rgba(255, 255, 255, 0.24)",this.domElement);this.bar.push(t)}return this.domElement.append(l),this.row.push(l),l}drawRowTitle(t,e,s){let i=document.createElementNS("http://www.w3.org/2000/svg","g");return i.innerHTML=`\n        <text style="fill:#959595;font:17px arial;">\n            <tspan x='${t+10}' y='${e+26}'>T</tspan>\n            <tspan x='${t+10}' y='${e+22+26}'>A</tspan>\n            <tspan x='${t+10}' y='${e+44+26}'>B</tspan>\n        </text>\n        `,s&&s.append(i),i}}class f extends u{constructor(){super(),this.sectionIndicator=[],i.setAttributes(this.domElement,{"data-layer":"UILayer"})}createSectionIndicator(){let t=this.createRect(0,0,0,0,0,"rgba(0, 255, 255, 0.13)");return t.style={display:"none"},this.sectionIndicator.push(t),t}}class P{constructor(){this.background=new u,this.sheet=new y,this.notes=new w,this.foreground=new u}get flattened(){return[this.background,this.sheet,this.notes,this.foreground]}}class k extends P{constructor(){super(),this.ui=new f}get flattened(){return[this.background,this.ui,this.sheet,this.notes,this.foreground]}}class N{constructor(t){this.layerType=t,this.layers=new t,this.domElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),i.setStyle(this.domElement,{"user-select":"none",outline:"none"}),this.layers.flattened.forEach(t=>this.domElement.appendChild(t.domElement))}}var x=function(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{a(i.next(t))}catch(t){o(t)}}function l(t){try{a(i.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,l)}a((i=i.apply(t,e||[])).next())}))};class D{constructor(t){this.device=t,this.callbacks=new o(["pick"]),this.device.onmidimessage=this.onMessage.bind(this)}on(t,e){t in this.callbacks&&this.callbacks[t].push(e)}static isSupported(){return navigator.requestMIDIAccess}static enumerate(){return x(this,void 0,void 0,(function*(){let t=[];if(D.isSupported()){let e=yield navigator.requestMIDIAccess();for(let s of e.inputs.values())if(s.name.match(/LiCAP MIDI Device/)){t.push(new D(s)),console.log(`use ${s.name}`);break}}return t}))}onMessage(t){let e=15&t.data[0],s=[40,45,50,55,59,64].reverse();switch(console.log(t.data),t.data[0]>>4&15){case 8:break;case 9:this.callbacks.pick.callAll(e,t.data[1]-s[e],t.data[2]/255,t.timeStamp)}}}let E="data:audio/wav;base64,UklGRigHAABXQVZFZm10IBAAAAABAAEAgLsAAAB3AQACABAAZGF0YQQHAADw/wAAGAAgAOD+AP0I/Bj7OPr4+Uj5gPhw+BD4gPeQ96j5qPyo/vj9GPwo++j8wP9oAbAC6AOIBBADgADI/kj96PtI+9AB0AtgEYAZyCK4JlAimBkgBmjwAOUI3gDZKNco3LjlEO2o/CAQqBr4FqAM2ASw+njvCOpA+JAPOBzYDejzUOYw8PACmA1IEGAQkA8IC2AE8P44+rj2iPnQ7iDaQNOQ3QjscO6g57DjCOlA8qDzQPHY8QjzGPswBoANSBfAIGgooD51V+Ve1VDAOmgoGCAoHqggqCCYG7gQ4AJo+bj5uPEQ4jDZ2NNQ0HjPwMTbttOyy7kIweDJCNWI4YDwsPwQAwAQqB7II5AaiAxwAwgJ4BUgF6AM8APYAeAEiAZABej3oOjw4hjfGN4Q4ejo4PNQ+xj80Pzg/ggHoBboIegnWDBANZg2yCyQINAgiCcIKxAoQB9YFfAP2AbI/0D9wPqI90j0UOfQ2xjVeNUA3LDfMOXg6uDosOYg6GDrmPIQ+xAAMAoQFYAZCBRoD9gOMA+QD/APcApgEKgbYB3AFigOuAOg77jfgNwY4UDpSO/w7+DvAPE49WD++AV4Avj4cPKQ+qgKmBXgHigiWB+oFagM8AjYFZghUCLgHngX2BC4CEgC2ADQ/3AB8ANgA8j7uPMg71joyONA5ODowO6I8nD4aP44AbAKwBVgGvAY+BNwD+Ab6CzIM/gnYBUICugDsAIwBEgEIAEw/dD2OPEA8MDn4N7Q1+jVUNoQ51j02Pp4/Dj9CP6YBYAOaBLoETATkBRgF7AYcBZgD0ADwPlQ+Dj8OAFQ/wD5APUA/PAHwBCIEdAJqP+w/LgDmA1wFYAZUBewEJgI6ASABcgL8BPQFmgTwA0oCfAEWPxQ9dDzWPYw+jD9kPOQ5gjiaOag7oD2kPyI/iD9UPRA7MjrGPMY/GABCAAI+2j3iABQDsgUYBJICxgCYPz49hD22Pnw/iACMAPYBqAMgA8YDYAIKAaQATj+YP64+7D26PJ49bD70ADAA0ACGP5Y/CgAiAVYCWgJgAWo/xD9mP8gA5gF0AZgCkANyAxgCvgDSP2Y9jjzsPRg+Bj8YP5A/mD64Pao+TgA+ATIAYD6iPVI+EgCSAsIDwgNoAeYAtgA4P+YAVAEgAUgBCACaALAAAj+oPwg+Tj2WPVY9tj5EP6A/1j7+PUI9MjyYPKI9Oj0gPPQ8mj14Pmw/RABSAMYA5ADKAWIBggHcAbgBFAEmARYBIgAOPug+Bj54Pr4/IgAiAR4BmgGiAVgBKgDeAMQA0ACUAF4ADgBaAMABVgEIAIwALD/cABoAagBKAGAAOj+6Pwo/PD9+AAIA4gE8AVIBjgEgABo/Sj7aPkA+Wj5EPog+0D7APpA+XD6mPxI/jD/4P54/Uj86PsQ/Jj8IP14/cj9yP6IABgCQAS4BqgHGAcgBrgE+AHA/uD8CPyI++j7qP3Q/zgBKAE4AFj/sP5Y/mD+EABoAnADaAGI/dj6+PvI/8gCkATgBUgGsAXoBDAE4APQA3AD0AJoAjgCmAIQA/ACkAGw/4j+iP8QAvADGANoAHD+6P0Y/oj+wP6w/qj+QP9QADgBYAAo/oj86Pvg+1D70PpI+8j8wP5oAOD/KP2Q+jD5cPgQ+Pj36Pcw+OD4CPmA+Kj3MPeg9wD6gP3I/9gAwAEYAiACSAJQAqgCoAOoBDgG+AdQCQAKCAs4DIgM+AqgCCAHiAYwBgAGcAWIBOgD+AJoARAAQACoAdgCeALoAIj/YP1Y+jj4ePhg+mD8WP1Y/fj8yPyw/HD8cPtI+iD64Pqw+yj8kPwQ/bD9oP3I/MD76Ps4/eD+uABgAsgCCAIoAXgAMABoAOAAKAIQBGAFkAUQBQAEyAIYAtgBuAFwAVgBcAGAAZABqAFAATgAKAAYAbABCAG4/+D+2P5A/6j/CACAAPgAKAHYAGgAOABAAEAAGAD4/9j/sP9w/+D/+ADQARAC8AGYAWAAcP4A/eD8yP3Q/lD/UP8g/5D+mP3I/LD8MP3I/Vj+mP5o/vj9wP3o/fD9CP6A/lD/0P+w/yj/QP6I/cD8ePz4/PD9EP8IAGgA8ACwAQgCwAFAAagAoAAwAZABKAIYA7AD8AMIBKADkAJgAdgA4AAQASABAAEIAbAA+P9Y/4D/GAB4AAgASP84/xD/cP4A/iD+iP7A/rD+oP7Q/qD/gADAAOD/yP4w/lj+0P4g/0D/cP/Q//D/oP8o/0j/0P8gADgAYABQAFgAiACQABAAcP8w/5D/MACQACgAcP8Q/6j+KP7o/cj9yP0o/kD/aADwAHgBCAIwAtABQAGgAIgA4AD4AKAAWAB4AFAAsP8I/6D+wP5I/9j/EAB4/5D++P2o/Uj9OP04/sD/8ADIAUgCeAKQAg==";const S=function(t,e,s,i){t.notes[s]=t.notes[s].slice(0,i+1);let n=0;for(let e=0;e<=i;e++)n+=t.lengthPerBeat/t.notes[s][e][0];if(n>=t.beatPerSection)t.notes.splice(s+1,0,[]),t.notes[s+1].push(e);else if(n+t.lengthPerBeat/e[0]>t.beatPerSection){let i=t.beatPerSection-n,o=t.lengthPerBeat/(t.lengthPerBeat/e[0]-i);i=t.lengthPerBeat/i,t.notes[s].push([i,e[1],"linkStart"]),t.notes.splice(s+1,0,[]),t.notes[s+1].push([o,e[1],"linkEnd"])}else{let i=1-n%1;if(i>=t.lengthPerBeat/e[0])t.notes[s].push(e);else{let n=t.lengthPerBeat/e[0]-i;t.notes[s].push([t.lengthPerBeat/i,e[1],"linkStart"]),t.notes[s].push([t.lengthPerBeat/n,e[1],"linkEnd"])}}};class B{constructor(){this._running=!1,this._systemTime=0,this.lastTime=0,this.delay=33,this.funcs=[],this.timerId=null,this.executeFuncs=[]}searchIndex(t){let e=this.executeFuncs,s=0,i=e.length,n=0;for(;s<i;)t>=e[n=Math.floor(s+(i-s)/2)].time?s=n+1:i=n-1;return s}register(t){this.funcs.indexOf(t)||this.funcs.push(t)}registerDelay(t,e,s=1){let i=this._systemTime+e;this.registerDelayP(t,e,i,s)}unregister(t){this.funcs.map((e,s)=>{t===e&&this.funcs.splice(s,1)})}start(t=0){this._running||(this._running=!0,this._systemTime=t,this.lastTime=(new Date).getTime(),this.update())}stop(){this.timerId&&(clearTimeout(this.timerId),this.timerId=null),this._running=!1,this._systemTime=0,this.lastTime=0,this.clearFuncs(),this.clearDelayFuncs()}update(){let t=(new Date).getTime(),e=t-this.lastTime;this._systemTime+=e,this.funcs.forEach(t=>{t(e)}),this.executeFunc(),this.lastTime=t,this.timerId=setTimeout(this.update.bind(this),this.delay)}executeFunc(){if(this.executeFuncs[0]&&this.executeFuncs[0].time<this._systemTime){let t=this.executeFuncs.shift();if(t.func(),this.executeFunc(),t.loop>0&&0==--t.loop)return;let e=t.time+t.delay;this.registerDelayP(t.func,t.delay,e,t.loop)}}clearFuncs(){this.funcs=[]}clearDelayFuncs(){this.executeFuncs=[]}registerDelayP(t,e,s,i){let n=this.searchIndex(s),o={func:t,delay:e,time:s,loop:i};this.executeFuncs.splice(n,0,o)}}let C=new class{constructor(t){this.lengthPerBeat=4,this.beatPerSection=4,this.lineWidth=1200,this.sectionPerLine=4,this.stringPadding=16,this.linePerPage=20,this.lineMargin=42,this.linePadding=[32,14],this.lineDistance=90,this.sectionAddNoteNumber=16,this.linkerElement=[],this.startPosition=[this.lineMargin+this.linePadding[0]+20,120+this.linePadding[1]],this.lineStartPosition=[this.lineMargin,120],this.rawData=[],Object.assign(this,t),this.tabCanvas=new N(k);let e=this.lineWidth+2*this.linePadding[0]+84;i.setAttributes(this.tabCanvas.domElement,{width:`${e}`}),this.domElement=document.createElement("div"),this.domElement.append(this.tabCanvas.domElement),this.domElement.addEventListener("keydown",t=>{let e=[37,38,39,40];for(let s=0;s<e.length;s++)e[s]===t.keyCode&&(t.preventDefault(),t.returnValue=!1)}),i.setStyle(this.domElement,{width:`${e+20}px`,height:"700px","overflow-y":"auto","overflow-x":"hidden"}),this.callbacks=new o(["noteclick","noteshiftclick","notealtclick","notectrlclick","keydown","mouseovernote","mouseoutnote","mousedown","mousemove","mouseup","rightclick"]),this.tabCanvas.domElement.addEventListener("focus",()=>{}),this.tabCanvas.domElement.addEventListener("keydown",this.onKeydown.bind(this)),this.tabCanvas.domElement.addEventListener("mousedown",this.onMouseDown.bind(this)),this.tabCanvas.domElement.addEventListener("mousemove",this.onMouseMove.bind(this)),this.tabCanvas.domElement.addEventListener("mouseup",this.onMouseUp.bind(this)),this.tabCanvas.domElement.addEventListener("contextmenu",this.onMouseRightClick.bind(this))}setData(t){this.notes=t}getNoteData(t,e){return this.notes[t][e]}setNoteData(t,e,s){this.notes[t][e]=s}setStringDataOfNote(t,e,s,i){s>=0&&s<=5&&(this.notes[t][e][1][s]=i)}getSectionData(t){return this.notes[t]}deleteNote(t,e){this.notes[t].splice(e,1)}addNote(t,e,s){t>=this.notes.length&&(t=this.notes.length,this.notes.push([])),this.notes[t].splice(e,0,s)}isBlankNote(t,e){for(let s=0;s<6;s++)if(-1!=this.notes[t][e][1][s])return!1;return!0}getSVGNote(t,e){return this.tabCanvas.layers.notes.noteElements.find(s=>s.section==t&&s.note==e)}getNotePosition(t,e,s=0){let i=0;if(-1==t&&(t=this.notes.length-1),-1==e&&(e=this.notes[t].length-1),t>=this.notes.length||t<-1||e>=this.notes[t].length||e<-1||s>5||s<0)return[-1,-1];for(let e=0;e<t;e++)i+=this.notes[e].length;i+=e;let n=this.tabCanvas.layers.notes.noteElements[i].blockGroup[s];return[n.x,n.y]}getNoteNumberOfSection(t){return-1==t&&(t=this.notes.length-1),this.notes[t].length}getSectionNumber(){return this.notes.length}instrumentNoteInput(t,e,s=-1,i=-1){-1==s&&(s=this.notes.length-1),-1==i&&(i=this.notes[s].length-1),t(this,e,s,i),this.render()}attach(t){t.append(this.domElement)}noteIndex(t){return this.tabCanvas.layers.notes.noteElements.indexOf(t)}areaSelect(t,e,s,i){let n=this.tabCanvas.layers.notes.noteElements;var o=[];let r,l;for(let r=0;r<n.length;r++)for(let l=0;l<6;l++)n[r].blockGroup[l].x>=t&&n[r].blockGroup[l].x<=s&&n[r].blockGroup[l].y>=e&&n[r].blockGroup[l].y<=i&&o.push(r);return r=Math.min(...o),l=Math.max(...o),n.slice(r,l+1)}endsSelect(t,e){if(t>e){let s=e;e=t,t=s}return this.tabCanvas.layers.notes.noteElements.slice(t,e+1)}render(){this.setAllLine();let[t,e,s,n]=this.calNoteRawData();this.setSectionIndicator(n),this.setAllNoteElementData(t,e),this.setLinker(s);let o=Math.ceil(this.notes.length/this.sectionPerLine);this.height!=this.lineStartPosition[1]+(5*this.stringPadding+this.lineDistance)*o+70&&(this.height=this.lineStartPosition[1]+(5*this.stringPadding+this.lineDistance)*o+70,i.setAttributes(this.tabCanvas.domElement,{height:`${this.height}`}))}on(t,e){t in this.callbacks&&this.callbacks[t].push(e)}scrollTo(t){this.domElement.scrollTop=t}getSectionLeftTopPos(t){return t<this.notes.length?[this.tabCanvas.layers.ui.sectionIndicator[t].x,this.tabCanvas.layers.ui.sectionIndicator[t].y]:[-1,-1]}getSectionWidth(t){return t<this.notes.length&&this.tabCanvas.layers.ui.sectionIndicator[t].width,0}getSectionHeight(t){return t<this.notes.length&&this.tabCanvas.layers.ui.sectionIndicator[t].height,0}setAllLine(){let t=Math.ceil(this.notes.length/this.sectionPerLine),e=this.tabCanvas.layers.sheet.row.length;for(let s=e;s<t;s++){let t=this.lineStartPosition[0],e=this.lineStartPosition[1]+(5*this.stringPadding+this.lineDistance)*s;this.tabCanvas.layers.sheet.createRow(t,e,this.lineWidth,this.linePadding,this.stringPadding,this.sectionPerLine)}for(let s=t;s<e;s++)i.setStyle(this.tabCanvas.layers.sheet.row[s],{display:"none"});for(let e=0;e<t;e++)i.setStyle(this.tabCanvas.layers.sheet.row[e],{display:"unset"})}setSectionIndicator(t){if(t.length>this.tabCanvas.layers.ui.sectionIndicator.length){let e=t.length-this.tabCanvas.layers.ui.sectionIndicator.length;for(let t=0;t<e;t++)this.tabCanvas.layers.ui.createSectionIndicator()}for(let e=0;e<t.length;e++){let s=t[e][1][0]-t[e][0][0],i=5*this.stringPadding;this.tabCanvas.layers.ui.sectionIndicator[e].x=t[e][0][0],this.tabCanvas.layers.ui.sectionIndicator[e].y=t[e][0][1],this.tabCanvas.layers.ui.sectionIndicator[e].width=s,this.tabCanvas.layers.ui.sectionIndicator[e].height=i}}calNoteRawData(){let[t,e]=this.startPosition,s=(this.beatPerSection,this.lengthPerBeat,[]),i=[],n=0;this.rawData.splice(0,0,{x:0,y:0,length:0,blocks:null,tail:null,section:0,note:0});let o=1,r=-1;for(let l=0;l<this.notes.length;l++){let a=Math.floor(l/this.sectionPerLine),h=0;n=0;for(let t=0;t<this.sectionPerLine;t++)this.notes[a*this.sectionPerLine+t]?h+=this.notes[a*this.sectionPerLine+t].length+this.sectionAddNoteNumber:h+=this.sectionAddNoteNumber;let c=this.lineWidth*(this.notes[l].length+this.sectionAddNoteNumber)/h,d=0;for(let t=0;t<this.notes[l].length;t++)d+=this.lengthPerBeat/this.notes[l][t][0];let u=(c-20)/d;l%this.sectionPerLine==0&&(t=this.startPosition[0],0!=l&&(e+=5*this.stringPadding+this.lineDistance));let g=[[t-20,e],[0,e]],m=t+c;g[1][0]=m-20,this.tabCanvas.layers.sheet.bar[l].x1=m-20,this.tabCanvas.layers.sheet.bar[l].x2=m-20,i.push(g);for(let i=0;i<this.notes[l].length;i++){let a,h=this.notes[l][i],c=this.lengthPerBeat/h[0];n+c/this.lengthPerBeat>=.25?(a=this.calculateTail(this.rawData[o-1].length,h[0],-1,u),n=0):(a=this.calculateTail(this.rawData[o-1].length,h[0],n,u),n+=c/this.lengthPerBeat);let d=u*this.lengthPerBeat/h[0],g=this.updateRawData(o,t,e,h[0],h[1],a,l,i);g>=0&&r<0&&(r=g-1),o++,"linkStart"!==h[2]&&"linkEnd"!==h[2]||s.push([t,e]),t+=d}t=m}return this.rawData.shift(),[--o,r,s,i]}updateRawData(t,e,s,i,n,o,r,l){if(t>this.rawData.length)return console.error("array index erro, should not be greater than rawData.length"),-1;if(t===this.rawData.length)return this.rawData.push({x:e,y:s,length:i,blocks:n.slice(0,6),tail:o.slice(0,o.length),section:r,note:l}),t;let a=this.rawData[t];return a.x==e&&a.y==s&&a.length==i&&a.section==r&&a.note==l&&this.compareArray(a.blocks,n)&&this.compareArray(a.tail,o)?-1:(this.rawData[t].x=e,this.rawData[t].y=s,this.rawData[t].length=i,this.rawData[t].blocks=n.slice(0,6),this.rawData[t].tail=o.slice(0,o.length),this.rawData[t].section=r,this.rawData[t].note=l,t)}compareArray(t,e){if(t.length!=e.length)return!1;for(let s=0;s<t.length;s++)if(t[s]!=e[s])return!1;return!0}calculateTail(t,e,s,i){let n=i*this.lengthPerBeat/t*-1,o=8;if(-1==s&&(o=-8),0==s){if(8==e)return[o,0,0];if(16==e)return[o,o,0];if(32==e)return[o,o,o]}else if(8==e){if(8==t||16==t||32==t)return[n,0,0]}else if(16==e){if(8==t)return[n,o,0];if(16==t||32==t)return[n,n,0]}else if(32==e){if(8==t)return[n,o,o];if(16==t)return[n,n,o];if(32==t)return[n,n,n]}return[0,0,0]}setAllNoteElementData(t,e){let s=this.rawData,n=this.tabCanvas.layers.notes.noteElements,o=t-n.length,r={x:0,y:0,length:0,blocks:[-1,-1,-1,-1,-1,-1],tail:[0,0,0],section:0,note:0};for(let t=0;t<o;t++)this.tabCanvas.layers.notes.createNote(),n[n.length-1].blockGroup.forEach((t,e)=>{t.domelement.addEventListener("click",this.onNoteClicked.bind(this)),t.domelement.addEventListener("mouseover",this.onMouseOverNote.bind(this)),t.domelement.addEventListener("mouseout",this.onMouseOutNote.bind(this)),t.string=e,i.setAttributes(t.domelement,{"data-string":`${e}`})});e>0&&(e-=1);for(let o=e;o<t;o++)i.setStyle(n[o].domelement,{display:"unset"}),o!=s.length-1?s[o+1].x>s[o].x?this.setNoteElementData(n[o],s[o],s[o+1],.7*(s[o+1].x-s[o].x)):this.setNoteElementData(n[o],s[o],s[o+1],30):this.setNoteElementData(n[o],s[o],r,30);for(let e=t;e<n.length;e++)i.setStyle(n[e].domelement,{display:"none"})}setNoteElementData(t,e,s,i){this.setElementPosition(t,e.x,e.y,e.tail,e.section,e.note,i),this.setChordVisiable(t,e.x,e.y,e.length,e.blocks,e.tail,s.tail)}setElementPosition(t,e,s,n,o,r,l){let a=Math.floor(o/this.sectionPerLine);t.lineGroup[0].x1=e,t.lineGroup[0].y1=26+s+5*this.stringPadding,t.lineGroup[0].x2=e,t.lineGroup[0].y2=s,t.lineGroup[1].x1=e,t.lineGroup[1].y1=25+s+5*this.stringPadding,t.lineGroup[1].x2=e+n[0],t.lineGroup[1].y2=25+s+5*this.stringPadding,t.lineGroup[2].x1=e,t.lineGroup[2].y1=21+s+5*this.stringPadding,t.lineGroup[2].x2=e+n[1],t.lineGroup[2].y2=21+s+5*this.stringPadding,t.lineGroup[3].x1=e,t.lineGroup[3].y1=17+s+5*this.stringPadding,t.lineGroup[3].x2=e+n[2],t.lineGroup[3].y2=17+s+5*this.stringPadding;for(let n=0;n<6;n++)t.blockGroup[n].x=e,t.blockGroup[n].y=s+this.stringPadding*n,t.blockGroup[n].extendRect.y=s+this.stringPadding*(n-.5),t.blockGroup[n].extendRect.height=this.stringPadding,t.blockGroup[n].extendRect.width=l,i.setAttributes(t.blockGroup[n].domelement,{"data-x":`${e}`,"data-y":`${s+this.stringPadding*n}`,"data-line":`${a}`});t.tail8.setPosition(e,s+5*this.stringPadding+15),t.tail16.setPosition(e,s+5*this.stringPadding+10),t.tail32.setPosition(e,s+5*this.stringPadding+5),t.section=o,t.note=r,t.line=a,i.setAttributes(t.domelement,{"data-section":`${o}`,"data-note":`${r}`}),t.blockGroup.forEach((t,e)=>{t.section=o,t.note=r,t.line=a,i.setAttributes(t.domelement,{"data-section":`${o}`,"data-note":`${r}`,"data-line":`${a}`})})}setChordVisiable(t,e,s,n,o,r,l){let a=!0;t.tail8.hide(),t.tail16.hide(),t.tail32.hide();for(let t=0;t<3;t++)if(r[t]<0||l[t]<0){a=!1;break}a&&(8==n?t.tail8.show():16==n?t.tail16.show():32==n&&t.tail32.show(),t.lineGroup[1].x2=e,t.lineGroup[2].x2=e,t.lineGroup[3].x2=e);for(let e=0;e<6;e++)t.blockGroup[e].word.text=`${o[e]}`,t.blockGroup[e].wordBack.text=`${o[e]}`,-1==o[e]?i.setStyle(t.blockGroup[e].domelement,{display:"none"}):i.setStyle(t.blockGroup[e].domelement,{display:"block"});if(2==n)return void(t.lineGroup[0].y2=10+s+5*this.stringPadding);if(1==n)return void(t.lineGroup[0].y2=26+s+5*this.stringPadding);let h=6.5;for(let t=1;t<=6;t++)if(-1!=o[t-1]){h=t;break}t.lineGroup[0].y2=s+this.stringPadding*(h-1)}setLinker(t){let e=Math.floor(t.length/2),s=this.tabCanvas.layers.background.linker.length;for(let t=0;t<e-s;t++)this.tabCanvas.layers.background.createLinker();for(let s=0;s<e;s++)this.setLinkerData(this.tabCanvas.layers.background.linker[s],t[2*s],t[2*s+1])}setLinkerData(t,e,s){let n=e[1]+31+5*this.stringPadding;if(e[1]!==s[1]){let o=e[0]+30,r=e[0],l=`M ${r} ${n} C ${r+4} ${n+15}, ${o-4} ${n+15}, ${o} ${n} C ${o-4} ${n+12}, ${r+4} ${n+12}, ${r} ${n} `;n=s[1]+31+5*this.stringPadding,l+=`M ${r=s[0]-30} ${n} C ${r+4} ${n+15}, ${(o=s[0])-4} ${n+15}, ${o} ${n} C ${o-4} ${n+12}, ${r+4} ${n+12}, ${r} ${n}`,i.setAttributes(t,{d:l})}else i.setAttributes(t,{d:`M ${e[0]} ${n} C ${e[0]+4} ${n+15}, ${s[0]-4} ${n+15}, ${s[0]} ${n} C ${s[0]-4} ${n+12}, ${e[0]+4} ${n+12}, ${e[0]} ${n}`})}onNoteClicked(t){let e=Number(t.currentTarget.dataset.section),s=Number(t.currentTarget.dataset.note),i=Number(t.currentTarget.dataset.string),n=[Number(t.currentTarget.dataset.x),Number(t.currentTarget.dataset.y)];t.shiftKey?this.callbacks.noteshiftclick.callAll(e,s,i,n,t.currentTarget):t.altKey?this.callbacks.notealtclick.callAll(e,s,i,n,t.currentTarget):t.ctrlKey?this.callbacks.notectrlclick.callAll(e,s,i,n,t.currentTarget):this.callbacks.noteclick.callAll(e,s,i,n,t.currentTarget)}onKeydown(t){this.callbacks.keydown.callAll(t.key)}onMouseOverNote(t){let e=Number(t.currentTarget.dataset.section),s=Number(t.currentTarget.dataset.note),i=Number(t.currentTarget.dataset.string),n=[Number(t.currentTarget.dataset.x),Number(t.currentTarget.dataset.y)];this.callbacks.mouseovernote.callAll(e,s,i,n,t.currentTarget)}onMouseOutNote(t){let e=Number(t.currentTarget.dataset.section),s=Number(t.currentTarget.dataset.note),i=Number(t.currentTarget.dataset.string),n=[Number(t.currentTarget.dataset.x),Number(t.currentTarget.dataset.y)];this.callbacks.mouseoutnote.callAll(e,s,i,n,t.currentTarget)}onMouseDown(t){this.callbacks.mousedown.callAll(Number(t.x),Number(t.y))}onMouseMove(t){this.callbacks.mousemove.callAll(Number(t.x),Number(t.y))}onMouseUp(t){this.callbacks.mouseup.callAll(Number(t.x),Number(t.y))}onMouseRightClick(t){this.callbacks.rightclick.callAll(Number(t.x),Number(t.y))}};C.setData([[[4,[3,5,2,-1,-1,-1],null],[4,[-1,5,2,-1,-1,-1],null],[4,[-1,5,2,-1,-1,-1],null],[8,[-1,5,2,-1,-1,-1],null]],[[8,[-1,5,2,-1,-1,-1],null],[4,[-1,5,2,-1,-1,-1],null],[4,[-1,5,2,-1,-1,-1],null],[8,[-1,5,2,-1,-1,-1],null],[8,[-1,5,2,-1,-1,-1],null]]]);let I=new class{constructor(t){this.inputBlock=0,this.mouseDown=!1,this.mouseMove=!1,this.selectNotesIndicator=[],this.selectNotesIndicatorPadding=8,this.controlTab=t,this.indicator=this.controlTab.tabCanvas.layers.ui.createEllipse(0,0,8,8),this.shadowIndicator=this.controlTab.tabCanvas.layers.ui.createEllipse(0,0,8,8),this.indicator.cx=-20,this.indicator.cy=-20,this.indicator.fill="rgb(255, 50, 0)",this.shadowIndicator.cx=-20,this.shadowIndicator.cy=-20,this.shadowIndicator.fill="rgba(255, 50, 0, 0.6)",this.dragNDropSection=this.controlTab.tabCanvas.layers.ui.createRect(0,0,0,0,0,"rgba(255, 50, 0, 0.6)"),this.setEvents()}get SVGNote(){return this.selectedSVGNote}get SelectedNotes(){return this.selectedSVGNotes}undisplayIndicator(){this.indicator.style={display:"none"},this.shadowIndicator.style={display:"none"},this.selectNotesIndicator.forEach((t,e,s)=>{t.style={display:"none"}})}displayIndicator(){this.indicator.style={display:"unset"},this.shadowIndicator.style={display:"unset"},this.selectNotesIndicator.forEach((t,e,s)=>{t.style={display:"unset"}})}setEvents(){this.controlTab.on("noteclick",(t,e,s,i)=>{this.setNoteClickEvent(t,e,s,i),this.selectedSVGNote=this.controlTab.getSVGNote(t,e),this.unselectSVGNotes()}),this.controlTab.on("noteshiftclick",(t,e,s,i)=>{this.unselectSVGNotes(),this.controlTab.getSVGNote(t,e),this.selectedSVGNotes=this.controlTab.endsSelect(this.controlTab.noteIndex(this.selectedSVGNote),this.controlTab.noteIndex(this.controlTab.getSVGNote(t,e))),this.drawMultiSelectRect(this.selectedSVGNotes)}),this.controlTab.on("keydown",t=>{if(" "===t.toLowerCase()||isNaN(Number(t)))this.inputBlock=0;else if(this.selectedBlock){let e=10*this.inputBlock+Number(t);this.inputBlock=e<40?e:Number(t),this.controlTab.setStringDataOfNote(this.selectedBlock.section,this.selectedBlock.note,this.selectedBlock.string,this.inputBlock),this.controlTab.render()}if("d"===t.toLowerCase()||"arrowright"===t.toLowerCase()){if(this.selectedSVGNotes.length>0){let t=this.selectedSVGNotes[this.selectedSVGNotes.length-1].blockGroup[0];this.selectedBlock={section:t.section,note:t.note,string:t.string},this.unselectSVGNotes()}this.selectedBlock&&this.selectRight(this.selectedBlock,this.controlTab)}if("a"===t.toLowerCase()||"arrowleft"===t.toLowerCase()){if(this.selectedSVGNotes.length>0){let t=this.selectedSVGNotes[0].blockGroup[0];this.selectedBlock={section:t.section,note:t.note,string:t.string},this.unselectSVGNotes()}this.selectedBlock&&this.selectLeft(this.selectedBlock,this.controlTab)}if("w"===t.toLowerCase()||"arrowup"===t.toLowerCase()){if(this.selectedSVGNotes.length>0){let t=this.selectedSVGNotes[this.selectedSVGNotes.length-1].blockGroup[0];this.selectedBlock={section:t.section,note:t.note,string:t.string},this.unselectSVGNotes()}this.selectedBlock&&this.selectUp(this.selectedBlock,this.controlTab)}if("s"===t.toLowerCase()||"arrowdown"===t.toLowerCase()){if(this.selectedSVGNotes.length>0){let t=this.selectedSVGNotes[this.selectedSVGNotes.length-1].blockGroup[0];this.selectedBlock={section:t.section,note:t.note,string:t.string},this.unselectSVGNotes()}this.selectedBlock&&this.selectDown(this.selectedBlock,this.controlTab)}if("i"===t.toLowerCase()){if(this.selectedSVGNotes.length>0&&(this.selectedBlock={section:this.selectedSVGNotes[0].section,note:this.selectedSVGNotes[0].note,string:0},this.unselectSVGNotes()),this.selectedBlock){let t=this.insertEmptyNote(this.selectedBlock);this.controlTab.render(),this.selectNoteAndMoveIndicator(t.section,t.note,t.string)}this.controlTab.render()}if("delete"===t.toLowerCase()||"backspace"===t.toLowerCase())if(this.selectedSVGNotes.length>0){for(let t=this.selectedSVGNotes.length-1;t>=0;t--)this.controlTab.deleteNote(this.selectedSVGNotes[t].section,this.selectedSVGNotes[t].note),this.controlTab.render();this.unselectSVGNotes()}else this.selectedBlock&&this.deleteNoteBlock(this.selectedBlock,this.controlTab);"+"===t.toLowerCase()&&this.changeNoteLength("+"),"-"===t.toLowerCase()&&this.changeNoteLength("-")}),this.controlTab.on("mouseovernote",(t,e,s,i)=>{this.shadowIndicator.cx=i[0],this.shadowIndicator.cy=i[1]}),this.controlTab.on("mouseoutnote",(t,e,s,i)=>{this.shadowIndicator.cx=-20,this.shadowIndicator.cy=-20}),this.controlTab.on("mousedown",(t,e)=>{e+=this.controlTab.domElement.scrollTop,null!=this.dragNDropSection&&this.dragNDropSection.remove(),this.dragNDropSection=this.controlTab.tabCanvas.layers.ui.createRect(0,0,0,0,5,"rgba(255, 50, 0, 0.6)"),this.dragStartPos=[t,e],this.dragNDropSection.style={display:"none"},this.mouseDown=!0,this.mouseMove=!1,this.unselectSVGNotes()}),this.controlTab.on("mousemove",(t,e)=>{e+=this.controlTab.domElement.scrollTop,this.mouseDown&&(Math.sqrt(Math.pow(t-this.dragStartPos[0],2)+Math.pow(e-this.dragStartPos[1],2))>1&&(this.mouseMove=!0,this.selectedBlock&&this.controlTab.isBlankNote(this.selectedBlock.section,this.selectedBlock.note)&&(this.controlTab.deleteNote(this.selectedBlock.section,this.selectedBlock.note),this.unselectNoteBlock(),this.controlTab.render())),this.mouseMove&&(t-this.dragStartPos[0]>=0?this.dragNDropSection.x=this.dragStartPos[0]:this.dragNDropSection.x=t,e-this.dragStartPos[1]>=0?this.dragNDropSection.y=this.dragStartPos[1]:this.dragNDropSection.y=e,this.dragNDropSection.setShape(Math.abs(t-this.dragStartPos[0]),Math.abs(e-this.dragStartPos[1])),this.dragNDropSection.style={display:"unset"}))}),this.controlTab.on("mouseup",(t,e)=>{if(e+=this.controlTab.domElement.scrollTop,this.mouseDown=!1,this.mouseMove){let s,i,n,o;this.dragNDropSection.remove(),t>=this.dragStartPos[0]?(s=this.dragStartPos[0],n=t):(s=t,n=this.dragStartPos[0]),e>=this.dragStartPos[1]?(i=this.dragStartPos[1],o=e):(i=e,o=this.dragStartPos[1]),this.selectedSVGNotes=this.controlTab.areaSelect(s,i,n,o),this.drawMultiSelectRect(this.selectedSVGNotes)}})}selectNoteAndMoveIndicator(t,e,s){let i=this.controlTab.getNotePosition(t,e,s);return-1!==i[0]&&(this.setSelectNote(t,e,s),this.setIndicator(i),!0)}setNoteClickEvent(t,e,s,i){this.setSelectNote(t,e,s),this.setIndicator(i)}setSelectNote(t,e,s){this.selectedBlock={section:t,note:e,string:s}}setIndicator(t){this.indicator.cx=t[0],this.indicator.cy=t[1]}changeNoteLength(t){let e;if("+"===t)e=1;else{if("-"!==t)return;e=0}if(this.selectedBlock){let t=[1,2,4,8,16,32],s=this.controlTab.getNoteData(this.selectedBlock.section,this.selectedBlock.note);for(let i=1-e;i<t.length-e;i++)if(t[i]===s[0]){s[0]=t[i-1+2*e],this.controlTab.setNoteData(this.selectedBlock.section,this.selectedBlock.note,s),this.controlTab.render(),this.selectNoteAndMoveIndicator(this.selectedBlock.section,this.selectedBlock.note,this.selectedBlock.string);break}}}selectRight(t,e){let s=this.selectNoteAndMoveIndicator(t.section,t.note+1,t.string);if(s)e.isBlankNote(t.section,t.note)&&(e.deleteNote(t.section,t.note),e.render(),this.selectNoteAndMoveIndicator(t.section,t.note,t.string));else if(e.isBlankNote(t.section,t.note)){1!=e.getNoteNumberOfSection(t.section)&&(e.deleteNote(t.section,t.note),e.render()),(s=this.selectNoteAndMoveIndicator(t.section+1,0,t.string))||(e.addNote(t.section+1,0,[4,[-1,-1,-1,-1,-1,-1],null]),e.render(),this.selectNoteAndMoveIndicator(t.section+1,0,t.string))}else e.addNote(t.section,t.note+1,[4,[-1,-1,-1,-1,-1,-1],null]),e.render(),this.selectNoteAndMoveIndicator(t.section,t.note+1,t.string)}selectLeft(t,e){if(0===t.note){if(t.section>0){let s=e.getNoteNumberOfSection(t.section-1)-1;this.selectNoteAndMoveIndicator(t.section-1,s,t.string)}}else e.isBlankNote(t.section,t.note)?(e.deleteNote(t.section,t.note),e.render(),this.selectNoteAndMoveIndicator(t.section,t.note-1,t.string)):this.selectNoteAndMoveIndicator(t.section,t.note-1,t.string)}selectUp(t,e){t.string>0&&this.selectNoteAndMoveIndicator(t.section,t.note,t.string-1)}selectDown(t,e){t.string<5&&this.selectNoteAndMoveIndicator(t.section,t.note,t.string+1)}insertEmptyNote(t){return this.controlTab.isBlankNote(this.selectedBlock.section,this.selectedBlock.note)||(this.controlTab.addNote(this.selectedBlock.section,this.selectedBlock.note,[4,[-1,-1,-1,-1,-1,-1],null]),this.selectedBlock={section:this.selectedBlock.section,note:this.selectedBlock.note,string:this.selectedBlock.string}),this.selectedBlock}deleteNoteBlock(t,e){this.controlTab.setStringDataOfNote(t.section,t.note,t.string,-1),e.render()}drawMultiSelectRect(t){let e=[];for(let s=0;s<t.length;s++)e.push(t[s].line);let s=e.filter((function(t,e,s){return e==s.indexOf(t)}));if(t.length>0){this.unselectNoteBlock();let e=[];for(let i=0;i<s.length;i++){let n=t.filter((function(t,e,n){return t.line==s[i]}));e.push({lineIndex:s[i],notes:n})}for(let t=0;t<e.length;t++){let s=e[t].notes[0].blockGroup[0],i=e[t].notes[e[t].notes.length-1].blockGroup[e[t].notes[e[t].notes.length-1].blockGroup.length-1];this.selectNotesIndicator.push(this.controlTab.tabCanvas.layers.ui.createRect(s.x-this.selectNotesIndicatorPadding,s.y-this.selectNotesIndicatorPadding,i.x-s.x+2*this.selectNotesIndicatorPadding,i.y-s.y+2*this.selectNotesIndicatorPadding,5,"rgba(255, 182, 45, 0.6)"))}}}unselectSVGNotes(){this.selectedSVGNotes=[],this.selectNotesIndicator.length>0&&this.selectNotesIndicator.forEach((t,e,s)=>{t.remove()})}unselectNoteBlock(){this.selectedBlock=null,this.setIndicator([-20,-20])}}(C);C.attach(document.getElementById("slimtab")),document.addEventListener("keydown",t=>{let e=[37,38,39,40];for(let s=0;s<e.length;s++)e[s]===t.keyCode&&(t.preventDefault(),t.returnValue=!1)}),C.render();let v=new class{constructor(t){this.rawData=[],this.spb=500,this.lengthPerBeat=4,t&&(this.spb=6e4/t)}receiveData(t,e,s,i){this.rawData.push([t,e,i]),this.receiveInterval||(this.receiveInterval=setTimeout(this.packNote.bind(this),10))}setSendDataCallBack(t){this.sendData=t}packNote(){let t=[-1,-1,-1,-1,-1,-1];for(let e=0;e<this.rawData.length;e++)t[this.rawData[e][0]]=this.rawData[e][1];if(this.noteRawData){let t=this.rawData[0][2]-this.preTime;if(t>this.spb*this.lengthPerBeat)this.noteRawData[0]=1;else{let e=Math.log(this.spb/t)/Math.log(2),s=(Math.log(this.spb/(3*t)),Math.log(2),Math.pow(2,Math.ceil(e-.5)));this.noteRawData[0]=this.lengthPerBeat*s}console.log(this.noteRawData),this.sendData(this.noteRawData)}this.preTime=this.rawData[0][2],this.noteRawData=[8,t,null],this.rawData=[],this.receiveInterval=null}};D.enumerate().then(t=>{t.length>0&&t[0].on("pick",v.receiveData.bind(v))}),v.setSendDataCallBack(t=>C.instrumentNoteInput(S,t));let T=new class{constructor(t){this.bpm=120,this.timeOffset=.05,this.currentTime=0,this.scheduleOsc=[],this.audioContext=new AudioContext,t&&(this.bpm=t),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=.3,this.gainNode.connect(this.audioContext.destination),fetch(E).then(t=>t.arrayBuffer()).then(t=>this.audioContext.decodeAudioData(t)).then(t=>this.sound=t)}startTick(){if(!this.tickTimer){let t=60/this.bpm;this.audioContext.suspend();let e=this.audioContext.currentTime;this.nextTime=e+t,this.tickTimer=-1*setTimeout(()=>{this.tick(),this.tickTimer=setInterval(()=>this.tick(),1e3*t)},1e3*t-1e3*this.timeOffset),this.makeSound(e),this.audioContext.resume()}}stopTick(){this.tickTimer<0?clearTimeout(-1*this.tickTimer):clearInterval(this.tickTimer),this.audioContext.suspend(),this.clearScheduleOsc(),this.currentTime=this.audioContext.currentTime,this.tickTimer=null}setBpm(t){this.bpm=t}scheduleTick(t,e="normal"){let s=1e3*this.currentTime+t;this.scheduleOsc.push(this.makeSound(s/1e3))}play(){this.audioContext.resume()}clearScheduleOsc(){for(let t=0;t<this.scheduleOsc.length;t++)this.scheduleOsc[t].disconnect();this.scheduleOsc=[]}tick(){let t=this.audioContext.currentTime,e=60/this.bpm;t>this.nextTime?(this.timeOffset+=.05,this.makeSound(t+this.timeOffset),this.nextTime=t+this.timeOffset+e):(this.makeSound(this.nextTime),this.nextTime+=e)}makeSound(t){let e=this.audioContext.createBufferSource();return e.buffer=this.sound,e.connect(this.gainNode),e.start(t),e.stop(t+.05),e}}(120),G=0,$=document.getElementById("metronome");$.onclick=function(t){0==G?(T.startTick(),$.style.background="#e99415",G=1):(T.stopTick(),$.style.background="",G=0)};let M;window.gg=()=>{M=setInterval((function(){C.instrumentNoteInput(S,[8,[-1,-1,-1,4,-1,6],null])}),100)},window.gx=()=>{clearInterval(M)},C.instrumentNoteInput(S,[4,[-1,-1,-1,4,-1,6],null]),C.instrumentNoteInput(S,[4,[-1,-1,-1,4,-1,6],null],0,2),C.on("noteclick",(t,e,s)=>{document.getElementById("section-idx").innerText=function(t,e){return("000000000"+t).substr(-e)}(String(t+1),3)+"."});let L=new class{constructor(){this.ctx=new AudioContext,this.sampleRate=32e3,this.startAt=0,this.wsL=new WebSocket("ws://localhost:9002/LiCAP/L/subscribe"),this.wsR=new WebSocket("ws://localhost:9002/LiCAP/R/subscribe"),this.wsL.binaryType="arraybuffer",this.wsR.binaryType="arraybuffer"}play(){this.wsL.onmessage=t=>{let e=new Float32Array(t.data),s=this.ctx.createBufferSource(),i=this.ctx.createBuffer(1,e.length,this.sampleRate);i.getChannelData(0).set(e),s.buffer=i,s.connect(this.ctx.destination),this.startAt=Math.max(this.ctx.currentTime,this.startAt),s.start(this.startAt),this.startAt+=i.duration}}};document.getElementById("playstream").addEventListener("click",()=>{L.play()}),console.log(C);new class{constructor(t,e){this.inputBlock=0,this.nowPlaySection=0,this.bpm=120,this.timeSignature={upper:4,lower:4},this.isRepeat=!1,this.indicatorColor="rgba(255, 209, 81, 0.6)",this.indicatorShapes=[],this.playSwitch=!1,this.timer=new B,this.controlTab=t,this.editor=e,this.setEvents()}play(){if(this.editor.SelectedNotes.length>0){this.isRepeat=!0;let t=this.sortBySectionId(this.editor.SelectedNotes),e=0;this.editor.undisplayIndicator(),null!=this.nowPlaySectionIndicator&&this.nowPlaySectionIndicator.remove(),t.forEach((t,s,i)=>{let n=this.sectionTwoEnds(t);0==s&&(this.nowPlaySectionIndicator=this.controlTab.tabCanvas.layers.ui.createRect(n.x1,n.y1,n.x2-n.x1,n.y2-n.y1,2,this.indicatorColor));let o=0;if(t.forEach((t,e,s)=>{let i=this.controlTab.getNoteData(t.section,t.note);o+=this.noteValeu2Time(i[0])}),e+=o,1==i.length)this.timer.registerDelay(this.stopNowPlayIndicator.bind(this),1e3*o,1);else if(i.length>1&&s<i.length-1){let t=this.sectionTwoEnds(i[s+1]);this.indicatorShapes.push({x:t.x1,y:t.y1,width:t.x2-t.x1,height:t.y2-t.y1}),this.timer.registerDelay(this.pushNowPlayIndicator.bind(this),1e3*e,1)}else s==i.length-1&&this.timer.registerDelay(this.play.bind(this),1e3*e,1)})}this.timer.start()}stop(){this.timer.stop(),this.stopNowPlayIndicator(),this.indicatorShapes=[]}pushNowPlayIndicator(){let t=this.indicatorShapes.shift();this.nowPlaySectionIndicator.setPos(t.x,t.y),this.nowPlaySectionIndicator.setShape(t.width,t.height)}stopNowPlayIndicator(){this.nowPlaySectionIndicator.remove()}noteValeu2Time(t){return this.timeSignature.lower/t/(this.bpm/60)}setEvents(){this.controlTab.on("keydown",t=>{" "===t.toLowerCase()&&(this.playSwitch=!this.playSwitch,this.playSwitch?this.play():this.stop())})}sortBySectionId(t){let e=[];for(let s=0;s<t.length;s++)e.push(t[s].section);let s=e.filter((function(t,e,s){return e==s.indexOf(t)})),i=[];for(let e=0;e<s.length;e++){let n=t.filter((function(t,i,n){return t.section==s[e]}));i.push(n)}return i}sectionTwoEnds(t){let e=t[0].blockGroup.length,s={x:t[0].blockGroup[0].x,y:t[0].blockGroup[0].y},i={x:t[t.length-1].blockGroup[e-1].x,y:t[t.length-1].blockGroup[e-1].y};if(0==t[0].note){let e=this.controlTab.tabCanvas.layers.ui.sectionIndicator[t[0].section];s={x:e.x,y:e.y}}if(t[t.length-1].note==this.controlTab.notes[t[t.length-1].section].length-1){let e=this.controlTab.tabCanvas.layers.ui.sectionIndicator[t[t.length-1].section];i={x:e.x+e.width,y:e.y+e.height}}return{x1:s.x,y1:s.y,x2:i.x,y2:i.y}}}(C,I)}]);
//# sourceMappingURL=demo.js.map